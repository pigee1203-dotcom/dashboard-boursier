<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Boursier ‚Äî Financier Premium (Guid√©)</title>

<!-- Chart.js + candlestick plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.0.0/dist/chartjs-chart-financial.min.js"></script>

<style>
/* ===== Theme: Financier Premium (clair, glassmorphism) ===== */
:root{
  --bg1:#f6fbff;
  --glass: rgba(255,255,255,0.62);
  --accent:#2b8cff;
  --accent-2:#8a63ff;
  --muted:#6b7280;
  --success:#16a34a;
  --danger:#ef4444;
  --card-radius:14px;
  --shadow: 0 10px 30px rgba(16,24,40,0.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(120deg,#f6fbff 0%, #fff7fb 60%); color:#07203a; -webkit-font-smoothing:antialiased; padding:20px;
}
.container{max-width:1280px;margin:0 auto}

/* Header */
.header{display:flex;gap:18px;align-items:flex-start;justify-content:space-between}
.title h1{margin:0;font-size:26px}
.title p{margin:6px 0 0;color:var(--muted);font-size:13px}
.stats{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
.card-stat{background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.85));border-radius:var(--card-radius);padding:10px 14px;min-width:140px;border:1px solid rgba(255,255,255,0.6);box-shadow:var(--shadow)}
.card-stat .label{font-size:12px;color:var(--muted)}
.card-stat .value{font-size:18px;font-weight:700;margin-top:6px}

/* Controls */
.controls{margin-top:16px;display:flex;gap:10px;align-items:center;background:var(--glass);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.6);backdrop-filter: blur(6px)}
.controls input,.controls select,.controls button{padding:8px 10px;border-radius:8px;border:1px solid #e6eef8;background:white;font-size:14px}
.controls input{min-width:260px}

/* Grid */
.grid{margin-top:16px;display:grid;grid-template-columns:380px 1fr;gap:16px;align-items:start}

/* Left */
.left{display:flex;flex-direction:column;gap:12px}
.panel{background:var(--glass);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.6);backdrop-filter: blur(6px);box-shadow:var(--shadow)}
.watchlist-list{display:flex;flex-direction:column;gap:10px;max-height:540px;overflow:auto;padding-right:6px}
.ticker-item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.94),rgba(250,250,250,0.96));border:1px solid rgba(230,238,248,0.8);transition:transform .12s,box-shadow .12s}
.ticker-item:hover{transform:translateY(-4px);box-shadow:0 12px 26px rgba(16,24,40,0.06);cursor:pointer}
.ticker-left{display:flex;gap:10px;align-items:center}
.ticker-symbol{font-weight:700;font-size:15px}
.ticker-price{font-weight:700;font-size:15px}
.ticker-meta{font-size:12px;color:var(--muted)}
.spark{width:100px;height:28px}

/* Right */
.right{display:flex;flex-direction:column;gap:12px}
.chart-card{padding:14px;border-radius:12px;background:linear-gradient(180deg,#ffffffee,#f7fbffcc);border:1px solid rgba(255,255,255,0.6)}
.chart-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
.detail-pill{background:linear-gradient(180deg,#ffffff,#f6fbff);padding:8px 12px;border-radius:999px;font-size:13px;border:1px solid rgba(230,238,248,0.8)}

/* Table */
.table{margin-top:10px;border-radius:10px;overflow:hidden}
.row{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid rgba(230,238,248,0.8);background:#fff}
.row .col{flex:1;font-size:13px;color:#07203a}
.row .col.small{flex:0 0 90px;text-align:right}

/* Scanner & Heatmap */
.scanner-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
.heatmap{display:flex;flex-wrap:wrap;gap:6px}
.heat-tile{width:80px;height:48px;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;color:white;box-shadow:0 6px 14px rgba(16,24,40,0.06)}

/* Tools */
.small-input{padding:8px;border-radius:8px;border:1px solid #e6eef8}

/* Bottom nav, popup, modal */
.bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:999;background:linear-gradient(180deg,#ffffff,#f2f8ff);border-radius:28px;padding:8px 12px;box-shadow:0 8px 26px rgba(16,24,40,0.06);border:1px solid rgba(255,255,255,0.8);display:flex;gap:8px}
.btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(43,140,255,0.18)}
.popup{position:fixed;right:22px;top:22px;z-index:1500;min-width:240px;padding:12px;border-radius:10px;color:#fff;font-weight:700;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:0 10px 30px rgba(12,34,56,0.16);transform:translateY(-8px);opacity:0;animation:popupIn .45s forwards}
@keyframes popupIn{to{transform:translateY(0);opacity:1}}
.modal-bg{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(7,11,20,0.35);display:flex;align-items:center;justify-content:center;z-index:2000}
.modal{background:white;padding:18px;border-radius:12px;max-width:820px;box-shadow:0 20px 60px rgba(7,11,20,0.4)}

/* responsive */
@media (max-width:1000px){.grid{grid-template-columns:1fr}.bottom-nav{left:12px;transform:none}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="title">
      <h1>Dashboard Boursier ‚Äî Financier Premium (Guid√©)</h1>
      <p>Guide pour d√©butants + outils pro ‚Äî actualit√©s, alertes, scanner, heatmap et conseils automatiques.</p>
      <div class="stats" id="topStats"></div>
    </div>
    <div style="text-align:right">
      <div style="font-size:13px;color:var(--muted);margin-bottom:8px">Compte</div>
      <div style="background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;padding:10px 12px;border-radius:10px;font-weight:700">Premium</div>
    </div>
  </div>

  <div class="controls">
    <input id="searchInput" placeholder="Recherche (ex : AAPL, Tesla, NVDA...)">
    <select id="marketSelect"><option>Toutes bourses</option><option>NASDAQ</option><option>NYSE</option><option>TSX</option></select>
    <select id="sortSelect"><option value="market">Tendance</option><option value="gainers">Top Gainers</option><option value="losers">Top Losers</option></select>
    <button class="btn" onclick="refreshAll()">Actualiser</button>
    <button class="btn ghost" onclick="showOnboarding()">Tutoriel</button>
    <button class="btn ghost" onclick="startVoice()">üéôÔ∏è Voice</button>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="left">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong>Watchlist</strong><div style="font-size:12px;color:var(--muted)">Ajoute un ticker et clique Voir</div></div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="addTickerInput" placeholder="Ajouter (ex: AAPL)" class="small-input">
            <button onclick="addTickerFromInput()" class="btn">Ajouter</button>
          </div>
        </div>
        <div class="watchlist-list" id="watchlistList"></div>
      </div>

      <div class="panel" style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Alertes & Paper-trade</strong><div style="font-size:12px;color:var(--muted)">Notifications & journal</div></div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <input id="alertTicker" placeholder="Ticker" class="small-input" style="width:90px">
          <input id="alertPrice" placeholder="Prix" type="number" class="small-input" style="width:100px">
          <select id="alertDir" class="small-input"><option value="above">Au-dessus</option><option value="below">En-dessous</option></select>
          <button onclick="createAlert()" class="btn">Cr√©er</button>
        </div>
        <div id="alertsList" style="margin-top:12px"></div>

        <div style="margin-top:12px;border-top:1px dashed rgba(0,0,0,0.06);padding-top:12px">
          <strong>Calculatrice taille position</strong>
          <div style="font-size:13px;color:var(--muted);margin-bottom:8px">Risque par trade</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="accountSize" placeholder="Capital (‚Ç¨)" type="number" class="small-input" style="width:120px">
            <input id="riskPct" placeholder="% risque" type="number" class="small-input" style="width:100px">
            <input id="stopDist" placeholder="Stop (‚Ç¨/action)" type="number" class="small-input" style="width:120px">
            <button onclick="calculatePosition()" class="btn">Calculer</button>
          </div>
          <div id="positionResult" style="margin-top:8px;font-weight:700"></div>
        </div>

        <div style="margin-top:12px;border-top:1px dashed rgba(0,0,0,0.06);padding-top:12px">
          <strong>Paper-trade ‚Äî Journal</strong>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="ptTicker" placeholder="Ticker" class="small-input" style="width:100px">
            <input id="ptQty" placeholder="Qty" type="number" class="small-input" style="width:80px">
            <input id="ptPrice" placeholder="Price" type="number" class="small-input" style="width:100px">
            <button onclick="addPaperTrade()" class="btn">Ajouter</button>
          </div>
          <div id="paperTradesList" style="margin-top:10px;max-height:140px;overflow:auto"></div>
          <div style="font-size:12px;color:var(--muted);margin-top:6px">Les trades sont stock√©s localement (localStorage).</div>
        </div>

      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="chart-card panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong id="chartTitle">S√©lectionner un ticker</strong>
            <div style="font-size:13px;color:var(--muted)">Clique sur "Voir" dans la watchlist</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="rangeSelect"><option value="1d">1J</option><option value="5d">5J</option><option value="1mo" selected>1M</option><option value="6mo">6M</option><option value="1y">1A</option></select>
            <button class="btn ghost" onclick="toggleChartType()">Toggle graphique</button>
            <button class="btn" onclick="startRealtime()">Live</button>
          </div>
        </div>

        <canvas id="mainChart" style="margin-top:12px;width:100%;height:380px"></canvas>

        <div class="chart-controls" style="margin-top:8px">
          <div class="details" id="indicatorPills"></div>
        </div>

        <div style="margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,#fff,#f6fbff);border:1px solid rgba(230,238,248,0.8);">
          <strong>Conseil automatique (d√©butant)</strong>
          <div id="autoAdvice" style="margin-top:8px;color:#0b3b2b;font-weight:700">Aucune action s√©lectionn√©e.</div>
          <div style="margin-top:8px"><small style="color:var(--muted)">Bas√© sur : RSI, MA20/MA50, volume, momentum et news.</small></div>
        </div>
      </div>

      <div class="panel">
        <strong>R√©sum√© march√© / Scanner / Actualit√©s</strong>

        <div class="scanner-grid">
          <div>
            <h4 style="margin:6px 0">Scanner (rapide)</h4>
            <div id="scannerList"></div>
          </div>
          <div>
            <h4 style="margin:6px 0">Heatmap</h4>
            <div class="heatmap" id="heatmap"></div>
          </div>
        </div>

        <div style="margin-top:12px" class="table" id="tableList"></div>

        <div style="margin-top:12px"><strong>Actualit√©s (filtr√©es)</strong>
          <div id="newsFeed" style="margin-top:8px;max-height:220px;overflow:auto;padding-right:6px"></div>
        </div>

      </div>

    </div>
  </div>
</div>

<!-- bottom nav -->
<div class="bottom-nav">
  <button class="btn ghost" onclick="setMode('debutant')">D√©butant</button>
  <button class="btn ghost" onclick="setMode('pro')">Pro</button>
  <button class="btn" onclick="refreshAll()">Actualiser</button>
  <button class="btn" onclick="downloadCSV()">Exporter</button>
</div>

<!-- popup & onboarding -->
<div id="popupContainer"></div>
<div id="onboarding" class="modal-bg" style="display:none"><div class="modal">
  <h2>Bienvenue ‚Äî Tutoriel rapide</h2>
  <p>Ce dashboard te guide. Voici un guide express :</p>
  <ol>
    <li>Ajoute des tickers puis clique "Voir".</li>
    <li>Le conseil automatique t'indique un signal simple (RSI & MA).</li>
    <li>Utilise la calculatrice pour d√©finir la taille de position.</li>
    <li>Paper-trade pour t'entra√Æner sans argent r√©el.</li>
    <li>Active Live pour actualiser toutes les 5s (na√Øf).</li>
  </ol>
  <div style="margin-top:8px"><button class="btn" onclick="closeOnboarding()">J'ai compris</button></div>
</div></div>

<script>
/* ===========================
   CONFIG, SOURCES, HELPERS
   =========================== */
const PROXY = 'https://api.allorigins.win/raw?url=';
const API_QUOTE = s => `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(s)}`;
const API_CHART = (s, range='1mo') => `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(s)}?range=${range}&interval=1d`;
const NEWS_SOURCES = [
  'https://finance.yahoo.com/news/rssindex',
  'https://www.reuters.com/business/finance/rss',
  'https://www.investing.com/rss/news.rss'
];

let state = {
  watchlist: JSON.parse(localStorage.getItem('watchlist')) || ['AAPL','TSLA','NVDA','MSFT','AMZN'],
  alerts: JSON.parse(localStorage.getItem('alerts')) || [],
  paperTrades: JSON.parse(localStorage.getItem('paperTrades')) || [],
  lastPrices: {},
  chartType: 'line',
  liveInterval: null
};

function el(tag, attrs={}, children=[]){
  const d=document.createElement(tag);
  if(attrs.cls) d.className = attrs.cls;
  if(attrs.html) d.innerHTML = attrs.html;
  if(attrs.text) d.textContent = attrs.text;
  for(const k in attrs) if(!['cls','html','text'].includes(k)) d.setAttribute(k, attrs[k]);
  (Array.isArray(children)?children:[children]).forEach(c=>{ if(!c) return; d.appendChild(typeof c==='string'?document.createTextNode(c):c) });
  return d;
}
function fmtN(n){ if(n==null||isNaN(n)) return '--'; return (n>=1000000? (n/1000000).toFixed(1)+'M' : (n>=1000? (n/1000).toFixed(1)+'k' : n.toFixed(2))); }
function fmtInt(n){ if(n==null) return '--'; return Number(n).toLocaleString(); }

/* ===========================
   RENDER UI
   =========================== */
function renderTopStats(){
  const container = document.getElementById('topStats'); container.innerHTML='';
  const cards = [
    {label:'Tickers suivis', value: state.watchlist.length, sub:'Watchlist'},
    {label:'Alertes', value: state.alerts.length, sub:'Alertes actives'},
    {label:'Paper trades', value: state.paperTrades.length, sub:'Journal local'},
    {label:'Derni√®re MAJ', value: new Date().toLocaleTimeString(), sub:'Heure locale'}
  ];
  cards.forEach(c=>{
    const card = el('div',{cls:'card-stat'});
    card.innerHTML = `<div class="label">${c.label}</div><div class="value">${c.value}</div><div class="sub" style="color:var(--muted)">${c.sub}</div>`;
    container.appendChild(card);
  });
}

/* Watchlist + sparkline */
async function renderWatchlist(){
  const list = document.getElementById('watchlistList'); list.innerHTML='';
  for(const symbol of state.watchlist){
    const node = el('div',{cls:'ticker-item'});
    const left = el('div',{cls:'ticker-left'});
    const sym = el('div',{cls:'ticker-symbol', text:symbol});
    const priceSpan = el('div',{cls:'ticker-price', text:'--'});
    const meta = el('div',{cls:'ticker-meta', text:'Chargement...'});
    left.append(sym, priceSpan, meta);

    const right = el('div',{style:'display:flex;flex-direction:column;align-items:flex-end;gap:6px;'});
    const actions = el('div');
    const seeBtn = el('button',{cls:'btn ghost'},'Voir'); seeBtn.onclick = ()=> loadChartFor(symbol);
    actions.appendChild(seeBtn);

    const spark = el('canvas',{cls:'spark'}); spark.width=100; spark.height=28;
    right.append(actions, spark);

    node.append(left,right);
    list.appendChild(node);

    // fetch quote
    fetch(PROXY + encodeURIComponent(API_QUOTE(symbol)))
      .then(r=>r.json())
      .then(data=>{
        const q = data?.quoteResponse?.result?.[0];
        if(!q) return;
        const price = q.regularMarketPrice;
        const ch = q.regularMarketChangePercent;
        priceSpan.textContent = (price!=null? price.toFixed(2)+' ‚Ç¨' : '--');
        priceSpan.style.color = ch>0 ? 'var(--success)' : (ch<0 ? 'var(--danger)' : '#07203a');
        meta.textContent = `O:${fmtN(q.regularMarketOpen)} ‚Ä¢ H:${fmtN(q.regularMarketDayHigh)} ‚Ä¢ L:${fmtN(q.regularMarketDayLow)} ‚Ä¢ V:${fmtInt(q.regularMarketVolume)}`;
        const prev = state.lastPrices[symbol];
        if(prev!=null){
          if(price>prev) priceSpan.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}],{duration:280});
          else if(price<prev) priceSpan.animate([{transform:'translateY(0)'},{transform:'translateY(6px)'},{transform:'translateY(0)'}],{duration:280});
        }
        state.lastPrices[symbol]=price;

        // spark (5d)
        fetch(PROXY + encodeURIComponent(API_CHART(symbol,'5d'))).then(rr=>rr.json()).then(j=>{
          try{
            const res = j.chart.result[0];
            const closes = res.indicators.quote[0].close.filter(x=>x!=null);
            renderSparkline(spark, closes);
          }catch(e){}
        }).catch(()=>{});
      }).catch(()=>{ priceSpan.textContent='--'; meta.textContent='‚Äî'; });
  }
}
function renderSparkline(canvas, data){
  const ctx = canvas.getContext('2d'); const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h); if(!data || data.length===0) return;
  const min = Math.min(...data), max = Math.max(...data);
  ctx.lineWidth = 2; ctx.beginPath();
  data.forEach((v,i)=>{ const x = i*(w/(data.length-1)); const y = h - ((v-min)/(max-min))*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.strokeStyle = (data[data.length-1] >= data[0]) ? 'rgba(16,185,129,0.95)' : 'rgba(239,68,68,0.95)';
  ctx.stroke();
}

/* Table list */
function renderTableList(){
  const table = document.getElementById('tableList'); table.innerHTML='';
  let alt=false;
  state.watchlist.forEach(symbol=>{
    const row = el('div',{cls:'row'+(alt?' alt':'')});
    row.innerHTML = `<div class="col"><strong>${symbol}</strong></div>
      <div class="col small" id="row-price-${symbol}">--</div>
      <div class="col small" id="row-change-${symbol}">--</div>
      <div class="col small"><button class="btn ghost" onclick="loadChartFor('${symbol}')">Voir</button></div>`;
    table.appendChild(row);
    alt = !alt;
  });
}

/* Alerts UI */
function renderAlertsUI(){
  const elist = document.getElementById('alertsList'); elist.innerHTML='';
  state.alerts.forEach((a,i)=>{
    const node = el('div',{cls:'ticker-item', html:`<div><strong>${a.ticker}</strong> &nbsp; ${a.direction==='above'?'>':'<'} ${a.price} ‚Ç¨</div>`});
    const del = el('button',{cls:'btn ghost'},'Suppr'); del.onclick = ()=>{ state.alerts.splice(i,1); storeState(); renderAlertsUI(); };
    node.appendChild(del); elist.appendChild(node);
  });
}

/* Paper trades */
function renderPaperTrades(){
  const out = document.getElementById('paperTradesList'); out.innerHTML='';
  state.paperTrades.forEach((t,i)=>{
    const div = el('div',{cls:'panel', html:`<div><strong>${t.ticker}</strong> ‚Ä¢ qty:${t.qty} @ ${t.price} ‚Ç¨</div>`});
    const del = el('button',{cls:'btn ghost'}, 'Suppr'); del.onclick = ()=>{ state.paperTrades.splice(i,1); storeState(); renderPaperTrades(); };
    div.appendChild(del); out.appendChild(div);
  });
}

/* ===========================
   CHARTS / INDICATORS / ADVICE
   =========================== */
let mainChart = null;
async function loadChartFor(symbol){
  document.getElementById('chartTitle').textContent = symbol;
  try{
    const res = await fetch(PROXY + encodeURIComponent(API_CHART(symbol, document.getElementById('rangeSelect').value)));
    const j = await res.json();
    if(!j.chart || !j.chart.result){ alert('Donn√©es graphiques non disponibles'); return; }
    const r = j.chart.result[0];
    const timestamps = r.timestamp.map(ts => new Date(ts*1000).toLocaleDateString());
    const opens = r.indicators.quote[0].open;
    const highs = r.indicators.quote[0].high;
    const lows = r.indicators.quote[0].low;
    const closes = r.indicators.quote[0].close;

    const ctx = document.getElementById('mainChart').getContext('2d');
    if(mainChart) mainChart.destroy();

    if(state.chartType === 'line'){
      mainChart = new Chart(ctx, {
        type: 'line',
        data: { labels: timestamps, datasets:[{label:symbol,data:closes,borderColor:'rgba(43,140,255,0.95)',backgroundColor:'rgba(43,140,255,0.12)',tension:0.25}]},
        options: { responsive:true, plugins:{legend:{display:false}}}
      });
    } else {
      const ohlc = opens.map((o,i)=>({x:timestamps[i], o:o, h:highs[i], l:lows[i], c:closes[i]}));
      mainChart = new Chart(ctx, { type:'candlestick', data:{datasets:[{label:symbol,data:ohlc}]}, options:{responsive:true, plugins:{legend:{display:false}}} });
    }

    // indicators
    const ma20 = movingAverage(closes,20);
    const ma50 = movingAverage(closes,50);
    const rsiArray = computeRSI(closes,14);
    const rsi = rsiArray.slice(-1)[0] || null;

    // pills
    const pills = document.getElementById('indicatorPills'); pills.innerHTML='';
    pills.appendChild(el('div',{cls:'detail-pill'},`Dernier: ${(closes.slice(-1)[0]||0).toFixed(2)} ‚Ç¨`));
    pills.appendChild(el('div',{cls:'detail-pill'},`MA20: ${ma20.slice(-1)[0] ? ma20.slice(-1)[0].toFixed(2) : '--'}`));
    pills.appendChild(el('div',{cls:'detail-pill'},`MA50: ${ma50.slice(-1)[0] ? ma50.slice(-1)[0].toFixed(2) : '--'}`));
    pills.appendChild(el('div',{cls:'detail-pill'},`RSI: ${rsi ? Math.round(rsi) : '--'}`));

    // advice
    const advice = analyzeForAdvice({symbol, closes, ma20, ma50, rsi});
    document.getElementById('autoAdvice').textContent = advice.text;
    if(advice.type==='buy') showPopup(`${symbol}: Opportunit√© (RSI ${Math.round(rsi)})`, false);
    if(advice.type==='sell') showPopup(`${symbol}: Surachet√© ‚Äî vigilance`, true);

  }catch(e){
    console.warn('chart error',e);
    alert('Impossible de charger le graphique pour '+symbol);
  }
}

function movingAverage(data, period){
  const out=[];
  for(let i=0;i<data.length;i++){
    if(i<period-1){ out.push(null); continue; }
    let sum=0, count=0;
    for(let j=0;j<period;j++){ const v=data[i-j]; if(v!=null){ sum+=v; count++; } }
    out.push(count? sum/count : null);
  }
  return out;
}
function computeRSI(closes, period=14){
  if(!closes || closes.length < period+1) return Array(closes.length).fill(null);
  const deltas=[]; for(let i=1;i<closes.length;i++) deltas.push(closes[i]-closes[i-1]);
  let seed = deltas.slice(0,period); let up=0, down=0; seed.forEach(s=> s>0? up+=s : down+=Math.abs(s));
  up/=period; down/=period; const rsis=[]; let prevUp=up, prevDown=down;
  for(let i=period;i<deltas.length;i++){ const delta=deltas[i]; const u = delta>0?delta:0; const d = delta<0?Math.abs(delta):0;
    prevUp = (prevUp*(period-1)+u)/period; prevDown = (prevDown*(period-1)+d)/period; const rs = prevDown===0?100:prevUp/prevDown; const rsi = 100-(100/(1+rs)); rsis.push(rsi);
  }
  return Array(period).fill(null).concat(rsis);
}
function analyzeForAdvice({symbol, closes, ma20, ma50, rsi}){
  const lastIdx = closes.length-1;
  const lastMA20 = ma20[lastIdx]; const lastMA50 = ma50[lastIdx]; const prevMA20 = ma20[lastIdx-1]; const prevMA50 = ma50[lastIdx-1];
  let type='neutral', text='Aucune recommandation claire ‚Äî surveille les indicateurs et les news.';
  if(rsi && rsi < 30){ type='buy'; text = `RSI ${Math.round(rsi)} ‚Äî Opportunit√© potentielle d'achat. V√©rifie volume et news.`; }
  else if(rsi && rsi > 80){ type='sell'; text = `RSI ${Math.round(rsi)} ‚Äî Surachet√©. Prends des profits ou s√©curise.`; }
  if(prevMA20!=null && prevMA50!=null && lastMA20!=null && lastMA50!=null){
    if(prevMA20 < prevMA50 && lastMA20 > lastMA50){ type='buy'; text = `MA20 croise MA50 √† la hausse ‚Äî signal haussier.`; }
    if(prevMA20 > prevMA50 && lastMA20 < lastMA50){ type='sell'; text = `MA20 croise MA50 √† la baisse ‚Äî signal baissier.`; }
  }
  // add gentle beginner guidance appended
  if(type==='buy') text += ' (d√©butant : envisager petite position, stop serr√©)';
  if(type==='sell') text += ' (d√©butant : r√©duire exposition)';
  return {type, text};
}

/* ===========================
   ALERTS / SIZING / PAPER
   =========================== */
function createAlert(){
  const t = document.getElementById('alertTicker').value.trim().toUpperCase();
  const p = parseFloat(document.getElementById('alertPrice').value);
  const dir = document.getElementById('alertDir').value;
  if(!t || !p){ alert('Remplir ticker et prix'); return; }
  state.alerts.push({ticker:t, price:p, direction:dir, triggered:false});
  storeState(); renderAlertsUI(); document.getElementById('alertTicker').value=''; document.getElementById('alertPrice').value='';
  showPopup('Alerte cr√©√©e: '+t);
}
function calculatePosition(){
  const account = parseFloat(document.getElementById('accountSize').value);
  const riskPct = parseFloat(document.getElementById('riskPct').value);
  const stop = parseFloat(document.getElementById('stopDist').value);
  if(!account || !riskPct || !stop){ document.getElementById('positionResult').textContent='Remplir tous les champs'; return; }
  const riskAmount = account * (riskPct/100); const qty = Math.max(0, Math.floor(riskAmount / stop));
  document.getElementById('positionResult').textContent = `Taille: ${qty} actions (risque ${riskAmount.toFixed(2)} ‚Ç¨)`;
}
function addPaperTrade(){
  const t = document.getElementById('ptTicker').value.trim().toUpperCase();
  const qty = parseFloat(document.getElementById('ptQty').value);
  const price = parseFloat(document.getElementById('ptPrice').value);
  if(!t || !qty || !price){ alert('Remplir les champs trade'); return; }
  state.paperTrades.push({ticker:t, qty, price, when: Date.now()});
  storeState(); renderPaperTrades();
  document.getElementById('ptTicker').value=''; document.getElementById('ptQty').value=''; document.getElementById('ptPrice').value='';
  showPopup('Trade ajout√© (paper)');
}

/* ===========================
   NEWS (RSS via AllOrigins)
   =========================== */
async function loadNews(){
  const feedEl = document.getElementById('newsFeed'); feedEl.innerHTML = 'Chargement des news...';
  const items = [];
  for(const url of NEWS_SOURCES){
    try{
      const res = await fetch(PROXY + encodeURIComponent(url));
      const text = await res.text();
      const parser = new DOMParser(); const xml = parser.parseFromString(text, "text/xml");
      const rssItems = Array.from(xml.querySelectorAll('item')).slice(0,6);
      rssItems.forEach(it=>{
        const title = it.querySelector('title')?.textContent || 'Article';
        const link = it.querySelector('link')?.textContent || it.querySelector('guid')?.textContent || '#';
        items.push({title, link});
      });
    }catch(e){ /* ignore */ }
  }
  if(items.length===0){ feedEl.innerHTML = '<div style="color:var(--muted)">Aucune news (proxy/RSS indisponible)</div>'; return; }
  feedEl.innerHTML = items.slice(0,10).map(i=> `<div style="padding:8px 0;border-bottom:1px solid rgba(230,238,248,0.6)"><a href="${i.link}" target="_blank" style="color:#0645ad;text-decoration:none">${i.title}</a></div>`).join('');
}

/* ===========================
   SCANNER & HEATMAP (simple)
   - scanner: quick gainers/losers from watchlist
   - heatmap: color blocks based on change %
   =========================== */
async function updateScannerAndHeatmap(){
  const scannerEl = document.getElementById('scannerList'); scannerEl.innerHTML='Chargement...';
  const heatEl = document.getElementById('heatmap'); heatEl.innerHTML='';
  const rows = [];
  for(const s of state.watchlist){
    try{
      const res = await fetch(PROXY + encodeURIComponent(API_QUOTE(s)));
      const j = await res.json(); const q = j.quoteResponse?.result?.[0];
      if(!q) continue;
      rows.push({symbol:s, changePct: q.regularMarketChangePercent || 0, price: q.regularMarketPrice || 0, vol: q.regularMarketVolume || 0});
    }catch(e){}
  }
  // sort gainers/losers
  const gainers = [...rows].sort((a,b)=> (b.changePct||0) - (a.changePct||0)).slice(0,5);
  const losers = [...rows].sort((a,b)=> (a.changePct||0) - (b.changePct||0)).slice(0,5);
  scannerEl.innerHTML = `<div style="font-size:13px;color:var(--muted);margin-bottom:6px">Top Gainers</div>` + gainers.map(g=>`<div style="padding:6px 0">${g.symbol} ‚Ä¢ ${g.changePct!=null?g.changePct.toFixed(2)+'%':'--'} ‚Ä¢ ${g.price?g.price.toFixed(2)+'‚Ç¨':''}</div>`).join('');
  scannerEl.innerHTML += `<div style="font-size:13px;color:var(--muted);margin-top:8px;margin-bottom:6px">Top Losers</div>` + losers.map(g=>`<div style="padding:6px 0">${g.symbol} ‚Ä¢ ${g.changePct!=null?g.changePct.toFixed(2)+'%':'--'} ‚Ä¢ ${g.price?g.price.toFixed(2)+'‚Ç¨':''}</div>`).join('');

  // heatmap tiles
  rows.forEach(r=>{
    const tile = el('div',{cls:'heat-tile'});
    const pct = r.changePct || 0;
    // color from red -> green
    const green = Math.max(0, Math.min(255, Math.round(160 + 95*(pct/10)))); // rough
    const red = Math.max(0, Math.min(255, Math.round(255 - 180*(pct/10))));
    const bg = (pct >= 0) ? `linear-gradient(180deg, rgba(16,185,129,0.9), rgba(16,185,129,0.8))` : `linear-gradient(180deg, rgba(239,68,68,0.9), rgba(239,68,68,0.8))`;
    tile.style.background = bg;
    tile.innerHTML = `<div style="font-weight:700">${r.symbol}</div><div style="font-size:12px">${pct!=null?pct.toFixed(2)+'%':'--'}</div>`;
    heatEl.appendChild(tile);
  });
}

/* ===========================
   REFRESH / LIVE / EXPORT / STORAGE
   =========================== */
async function refreshAll(){
  // quick update quotes for watchlist rows
  for(const t of state.watchlist){
    try{
      const res = await fetch(PROXY + encodeURIComponent(API_QUOTE(t)));
      const data = await res.json();
      const q = data.quoteResponse?.result?.[0];
      if(!q) continue;
      const price = q.regularMarketPrice;
      const ch = q.regularMarketChangePercent;
      const rowPrice = document.getElementById('row-price-'+t); if(rowPrice) rowPrice.textContent = (price!=null? price.toFixed(2)+' ‚Ç¨' : '--');
      const rowCh = document.getElementById('row-change-'+t); if(rowCh) { rowCh.textContent = (ch!=null? ch.toFixed(2)+'%': '--'); rowCh.style.color = ch>0?'var(--success)':(ch<0?'var(--danger)':'#333'); }
      // alerts
      state.alerts.forEach(a=>{
        if(!a.triggered && a.ticker===t){
          if((a.direction==='above' && price >= a.price) || (a.direction==='below' && price <= a.price)){
            showPopup(`ALERTE: ${t} ${price.toFixed(2)} ‚Ç¨ (${a.direction==='above'? '>' : '<'} ${a.price})`, true);
            a.triggered = true; storeState();
          }
        }
      });
    }catch(e){}
  }
  renderTopStats(); renderWatchlist(); renderTableList(); renderAlertsUI(); renderPaperTrades();
  updateScannerAndHeatmap(); loadNews();
}

/* Live polling */
function startRealtime(){
  if(state.liveInterval){ clearInterval(state.liveInterval); state.liveInterval = null; showPopup('Live stopp√©'); return; }
  state.liveInterval = setInterval(refreshAll, 5000);
  showPopup('Live d√©marr√© ‚Äî rafra√Æchissement 5s');
}

/* CSV export */
function downloadCSV(){
  const rows = [['Ticker','Price','Change%']];
  Promise.all(state.watchlist.map(async t=>{
    try{ const r = await fetch(PROXY + encodeURIComponent(API_QUOTE(t))); const j = await r.json(); const q = j.quoteResponse.result[0]; rows.push([t, q.regularMarketPrice || '', q.regularMarketChangePercent || '']); }catch(e){ rows.push([t,'','']); }
  })).then(()=>{
    const csv = rows.map(r=> r.map(c=> `"${c}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'watchlist.csv'; a.click(); URL.revokeObjectURL(url);
  });
}

/* Storage */
function storeState(){ localStorage.setItem('watchlist', JSON.stringify(state.watchlist)); localStorage.setItem('alerts', JSON.stringify(state.alerts)); localStorage.setItem('paperTrades', JSON.stringify(state.paperTrades)); }

/* UI helpers */
function addTickerFromInput(){ const v=document.getElementById('addTickerInput').value.trim().toUpperCase(); if(!v) return; if(!state.watchlist.includes(v)) state.watchlist.push(v); document.getElementById('addTickerInput').value=''; storeState(); renderWatchlist(); renderTableList(); updateScannerAndHeatmap(); }
function setMode(mode){ showPopup('Mode: '+mode); }
function showPopup(text, important=false){ const p = el('div',{cls:'popup'}, text); if(important) p.style.background = 'linear-gradient(90deg,var(--danger),#ff9b9b)'; document.getElementById('popupContainer').appendChild(p); setTimeout(()=> p.remove(), 4200); }
function showOnboarding(){ document.getElementById('onboarding').style.display='flex'; }
function closeOnboarding(){ document.getElementById('onboarding').style.display='none'; }

/* Voice commands (simple) */
let recognition = null;
function startVoice(){
  if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)){ alert('Reconnaissance vocale non prise en charge dans ce navigateur.'); return; }
  const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new Rec();
  recognition.lang = 'fr-FR';
  recognition.interimResults = false;
  recognition.onresult = (e) => {
    const text = e.results[0][0].transcript.toLowerCase();
    showPopup('Commande vocale : '+text);
    // simple parser: "montre apple" or "montre AAPL"
    if(text.includes('montre') || text.includes('affiche')){
      const parts = text.split(' ');
      const candidate = parts[parts.length-1].toUpperCase();
      // if user said "apple" try AAPL mapping common
      const map = {'TESLA':'TSLA','APPLE':'AAPL','NVIDIA':'NVDA','MICROSOFT':'MSFT','AMAZON':'AMZN'};
      const ticker = map[candidate] || candidate;
      if(ticker) loadChartFor(ticker);
    }
  };
  recognition.onend = ()=> recognition=null;
  recognition.start();
  showPopup('√âcoute... dis "montre AAPL"');
}

/* Init */
renderTopStats(); renderWatchlist(); renderTableList(); renderAlertsUI(); renderPaperTrades(); refreshAll();
setInterval(storeState, 5000);
</script>
</body>
</html>
