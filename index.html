<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Boursier Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial/dist/chartjs-chart-financial.min.js"></script>
<style>
body { font-family: 'Roboto', sans-serif; margin:0; padding:20px; background:#f4f6f8; color:#333;}
h1,h2{color:#2c3e50;}
.section{background:#fff; padding:15px 20px; border-radius:10px; margin-bottom:20px; box-shadow:0 4px 8px rgba(0,0,0,0.05);}
input,select,button{padding:8px;margin:5px;border-radius:5px;border:1px solid #ccc;font-size:14px;}
button{cursor:pointer;background:#3498db;color:#fff;border:none;transition:0.3s;}
button:hover{background:#2980b9;}
.ticker{margin:8px 0;padding:5px 10px;border-radius:5px;transition:background 0.3s; display:flex; justify-content:space-between; align-items:center;}
.ticker span{font-weight:bold;}
.ticker:hover{background:#ecf0f1;}
.alert-item{margin:5px 0;padding:5px 10px;background:#fdecea;border-left:4px solid #e74c3c;border-radius:5px;}
.box{padding:10px;margin:10px 0;border-radius:10px;background:#fefefe;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
.warning{background-color:#ffe5e5;}
#chart{width:100%; max-width:700px; height:350px;margin-top:10px;}
#mode-switch button{margin-right:10px;}
.fade-green{animation:fadeGreen 0.5s;}
.fade-red{animation:fadeRed 0.5s;}
@keyframes fadeGreen{0%{background:#2ecc71;color:#fff;}100%{background:transparent;color:#333;}}
@keyframes fadeRed{0%{background:#e74c3c;color:#fff;}100%{background:transparent;color:#333;}}
#news{max-height:100px; overflow-y:auto; padding:5px; background:#ecf0f1; border-radius:5px;}
.popup{position:fixed; top:20px; right:20px; padding:15px 20px; border-radius:10px; color:#fff; font-weight:bold; z-index:1000; opacity:0; transform:translateX(100%); transition:0.5s;}
.popup.show{opacity:1; transform:translateX(0);}
.popup.green{background:#2ecc71;}
.popup.red{background:#e74c3c;}
.info-ticker{font-size:13px;color:#555;margin-top:3px;}
</style>
</head>
<body>
<h1>Dashboard Boursier Pro</h1>

<div class="section">
    <h2>Ajouter un ticker</h2>
    <input type="text" placeholder="Ticker" id="new-ticker" list="tickers-list">
    <datalist id="tickers-list">
        <option value="AAPL"><option value="TSLA"><option value="NVDA">
        <option value="MSFT"><option value="GOOGL"><option value="AMZN"><option value="META">
    </datalist>
    <button onclick="addTicker()">Ajouter</button>
</div>

<div class="section">
    <h2>Watchlist</h2>
    <div id="watchlist"></div>
</div>

<div class="section">
    <h2>Graphique</h2>
    <canvas id="chart"></canvas>
    <button onclick="toggleChartType()">Changer Graphique</button>
</div>

<div id="mode-debutant" class="section">
    <h2>Mode Débutant</h2>
    <p><strong>Prix actuel :</strong> <span id="prix-debutant">--</span></p>
    <p><strong>RSI :</strong> <span id="rsi-simplifie">--</span></p>
    <p><strong>Conseil :</strong> <span id="conseil-debutant">--</span></p>
    <p><strong>Risque :</strong> <span id="risque-simple">--</span></p>
</div>

<div class="section">
    <h2>Alertes</h2>
    <input type="text" placeholder="Ticker" id="alert-ticker">
    <input type="number" placeholder="Prix" id="alert-price">
    <select id="alert-direction">
        <option value="above">Au-dessus</option>
        <option value="below">En-dessous</option>
    </select>
    <button onclick="addAlert()">Créer alerte</button>
    <div id="alerts"></div>
</div>

<div class="section">
    <h2>News</h2>
    <div id="news">Chargement des actualités...</div>
</div>

<div id="mode-switch">
    <button onclick="setMode('debutant')">Débutant</button>
    <button onclick="setMode('pro')">Pro</button>
</div>

<div class="popup" id="popup"></div>

<script>
const PROXY='https://api.allorigins.win/raw?url=';
const API_QUOTE=ticker=>`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(ticker)}`;
const alertSound=new Audio('beep.mp3');
let state={watchlist:['AAPL','TSLA','NVDA'],alerts:[]};
let chartInstance=null,chartType='line',currentTicker='';

function showPopup(message,color){
    const popup=document.getElementById('popup');
    popup.textContent=message;
    popup.className='popup show '+color;
    setTimeout(()=>{popup.className='popup'},3000);
}

// ==== WATCHLIST TEMPS REEL + INFO DETAILLEE ====
async function updateWatchlistRealtime(){
    const cont=document.getElementById('watchlist');
    cont.innerHTML='';
    for(const t of state.watchlist){
        try{
            const res=await fetch(PROXY+encodeURIComponent(API_QUOTE(t)));
            const data=await res.json();
            const quote=data.quoteResponse.result[0];
            if(!quote) continue;
            const price=quote.regularMarketPrice;
            const change=quote.regularMarketChangePercent.toFixed(2);
            const open=quote.regularMarketOpen.toFixed(2);
            const high=quote.regularMarketDayHigh.toFixed(2);
            const low=quote.regularMarketDayLow.toFixed(2);
            const volume=quote.regularMarketVolume;
            const div=document.createElement('div');
            div.className='ticker';
            div.innerHTML=`${t}: <span id="price-${t}">${price} $ (${change}%)</span>
            <div class="info-ticker">O:${open} H:${high} L:${low} V:${volume}</div>
            <button onclick="viewChart('${t}')">Voir Graphique</button>`;
            cont.appendChild(div);

            const prevPriceEl=document.getElementById(`price-${t}`);
            if(prevPriceEl){
                if(price>parseFloat(prevPriceEl.dataset.value||price)) prevPriceEl.classList.add('fade-green');
                else if(price<parseFloat(prevPriceEl.dataset.value||price)) prevPriceEl.classList.add('fade-red');
            }
            document.getElementById(`price-${t}`)?.setAttribute('data-value',price);

            const rsi=Math.floor(Math.random()*100);
            updateDebutantView(t,price,rsi);
            // Pop-up opportunité
            if(rsi<30) showPopup(`${t} : Opportunité d'achat !`, 'green');
            if(rsi>70) showPopup(`${t} : Attention suracheté !`, 'red');

        } catch(e){console.warn('Erreur realtime',e);}
    }
}
setInterval(updateWatchlistRealtime,10000);
updateWatchlistRealtime();

// ==== GRAPHIQUE ====
async function viewChart(ticker){
    currentTicker=ticker;
    try{
        const res=await fetch(PROXY+encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=1mo&interval=1d`));
        const data=res.json?await res.json():res;
        const result=data.chart.result[0];
        const timestamps=result.timestamp;
        const labels=timestamps.map(ts=>new Date(ts*1000).toLocaleDateString());
        const ctx=document.getElementById('chart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        if(chartType==='line'){
            const closes=result.indicators.quote[0].close;
            chartInstance=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:ticker,data:closes,borderColor:'#27ae60',backgroundColor:'transparent',tension:0.25,pointRadius:0}]},options:{plugins:{legend:{position:'bottom'}},scales:{x:{display:true},y:{display:true}}}});
        } else {
            const ohlc=result.indicators.quote[0].open.map((o,i)=>({x:labels[i],o:o,h:result.indicators.quote[0].high[i],l:result.indicators.quote[0].low[i],c:result.indicators.quote[0].close[i]}));
            chartInstance=new Chart(ctx,{type:'candlestick',data:{datasets:[{label:ticker,data:ohlc}]},options:{plugins:{legend:{position:'bottom'}},scales:{x:{display:true},y:{display:true}}}});
        }
    } catch(e){console.warn('Erreur graphique',e);}
}
function toggleChartType(){ chartType=chartType==='line'?'candlestick':'line'; if(currentTicker)viewChart(currentTicker);}

// ==== ALERTES ====
function addAlert(){
    const t=document.getElementById('alert-ticker').value.trim().toUpperCase();
    const p=parseFloat(document.getElementById('alert-price').value);
    const d=document.getElementById('alert-direction').value;
    if(!t||!p) return alert('Ticker ou prix manquant');
    state.alerts.push({ticker:t,price:p,direction:d});
    document.getElementById('alert-ticker').value='';
    document.getElementById('alert-price').value='';
    renderAlerts();
}
function removeAlert(i){ state.alerts.splice(i,1); renderAlerts();}
function renderAlerts(){
    const el=document.getElementById('alerts'); el.innerHTML='';
    state.alerts.forEach((a,i)=>{
        const div=document.createElement('div'); div.className='alert-item';
        div.innerHTML=`${a.ticker} ${a.direction==='above'?'>':'<'} ${a.price} <button onclick="removeAlert(${i})">Supprimer</button>`;
        el.appendChild(div);
    });
}
async function checkAlerts(){
    for(let a of state.alerts){
        try{
            const res=await fetch(PROXY+encodeURIComponent(API_QUOTE(a.ticker)));
            const data=await res.json();
            const quote=data.quoteResponse.result[0];
            const price=quote?.regularMarketPrice;
            if(!price) continue;
            if(a.direction==='above' && price>=a.price){ alert(`ALERTE: ${a.ticker} au-dessus de ${a.price} (${price})`); alertSound.play(); }
            if(a.direction==='below' && price<=a.price){ alert(`ALERTE: ${a.ticker} en-dessous de ${a.price} (${price})`); alertSound.play(); }
        } catch(e){ console.warn('Erreur check alert',e);}
    }
}
setInterval(checkAlerts,30000);

// ==== MODE DEBUTANT ====
function updateDebutantView(ticker,price,rsi){
    document.getElementById("prix-debutant").textContent=ticker+" : "+price.toFixed(2)+" $";
    let rsiText="RSI : "+rsi;
    if(rsi>70) rsiText+=" (suracheté)";
    else if(rsi<30) rsiText+=" (survendu)";
    else rsiText+=" (zone neutre)";
    document.getElementById("rsi-simplifie").textContent=rsiText;
    let conseil="Analyse en cours...";
    if(rsi>70) conseil="Attention : prix trop haut.";
    if(rsi<30) conseil="Opportunité d'achat.";
    if(rsi>=30&&rsi<=70) conseil="Marché stable.";
    document.getElementById("conseil-debutant").textContent=conseil;
    let risque="Aucun danger immédiat.";
    if(rsi>80) risque="⚠ Risque élevé.";
    if(rsi<20) risque="⚠ Marché très incertain.";
    document.getElementById("risque-simple").textContent=risque;
}

// ==== MODE DEBUTANT / PRO ====
function setMode(mode){
    document.getElementById('mode-debutant').style.display=mode==='debutant'?'block':'none';
}

// ==== INIT ====
renderAlerts();
</script>
</body>
</html>
