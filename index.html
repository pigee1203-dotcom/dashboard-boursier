<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Boursier — Premium (Style A + Trader)</title>

<!-- Chart.js + candlestick plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.0.0/dist/chartjs-chart-financial.min.js"></script>

<style>
:root{
  --bg:#e8f4fb;
  --glass-bg: rgba(255,255,255,0.55);
  --accent-1: #3aa3ff;   /* bleu */
  --accent-2: #a970ff;   /* violet */
  --accent-3: #ffd36b;   /* jaune */
  --success: #2dd36f;
  --danger: #ff6b6b;
  --muted: #6b7280;
  --card-radius: 14px;
  --glass-border: rgba(255,255,255,0.6);
  --glass-blur: 10px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter, "Segoe UI", Roboto, Arial;
  background: linear-gradient(135deg,#e6f3ff 0%, #fff0f7 60%);
  color:#0f1724;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding:22px;
}

/* Container */
.app {
  max-width:1200px;
  margin:0 auto;
}

/* Header */
.header {
  display:flex;
  align-items:flex-start;
  gap:18px;
  margin-bottom:18px;
}
.title {
  flex:1;
}
.title h1{
  margin:0;
  font-size:28px;
  letter-spacing:-0.5px;
  color: #07203a;
  text-shadow: 0 1px 0 rgba(255,255,255,0.6);
}
.title p{ margin:6px 0 0; color:var(--muted); font-size:14px; }

/* Top stats cards */
.stats {
  display:flex;
  gap:12px;
  margin-top:14px;
  flex-wrap:wrap;
}
.stat-card{
  flex:1 1 140px;
  min-width:140px;
  background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.45));
  border-radius: var(--card-radius);
  padding:14px;
  backdrop-filter: blur(var(--glass-blur));
  border: 1px solid var(--glass-border);
  box-shadow: 0 6px 18px rgba(12,34,56,0.06);
  transition: transform .18s ease, box-shadow .18s;
}
.stat-card:hover{ transform: translateY(-6px); box-shadow:0 12px 28px rgba(12,34,56,0.12); }
.stat-card .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
.stat-card .value{ font-size:22px; font-weight:700; }
.stat-card .sub{ font-size:12px; color:var(--muted); margin-top:6px; }

/* Controls area (filters) */
.controls {
  margin-top:18px;
  display:flex;
  gap:12px;
  align-items:center;
  background: linear-gradient(180deg, rgba(255,255,255,0.4), rgba(255,255,255,0.25));
  padding:12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.6);
  backdrop-filter: blur(6px);
}
.controls input[type="text"]{
  flex:1;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #e2e8f0;
  background: rgba(255,255,255,0.9);
}
.controls select, .controls button{
  padding:9px 12px;
  border-radius:8px;
  border:1px solid #e2e8f0;
  background: white;
}

/* Layout grid: left = watchlist/table, right = chart & details */
.grid {
  margin-top:16px;
  display:grid;
  grid-template-columns: 380px 1fr;
  gap:16px;
}

/* Left column: watchlist */
.left {
  display:flex;
  flex-direction:column;
  gap:12px;
}
.card {
  background: var(--glass-bg);
  border-radius:12px;
  padding:12px;
  border:1px solid var(--glass-border);
  backdrop-filter: blur(var(--glass-blur));
  box-shadow: 0 8px 20px rgba(12,34,56,0.05);
}
.watchlist-header { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; }
.watchlist-list { display:flex; flex-direction:column; gap:8px; max-height:560px; overflow:auto; padding-right:6px; }

/* Each ticker mini card */
.ticker-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  padding:10px;
  border-radius:10px;
  background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
  border: 1px solid rgba(255,255,255,0.6);
  transition: transform .12s ease, box-shadow .12s;
}
.ticker-item:hover{ transform: translateY(-4px); box-shadow:0 14px 30px rgba(12,34,56,0.08);}
.ticker-main{ display:flex; gap:10px; align-items:center;}
.ticker-symbol { font-weight:700; font-size:15px; color:#07203a;}
.ticker-price { font-weight:700; font-size:15px; }
.ticker-meta { font-size:12px; color:var(--muted); }
.ticker-actions button{ background:transparent; border:none; padding:6px; border-radius:8px; cursor:pointer; }
.ticker-tag { padding:4px 8px; border-radius:999px; background:rgba(10,20,60,0.06); font-size:12px; color: #084; }

/* small sparkline canvas */
.spark { width:100px; height:28px; }

/* Right column: chart + details */
.right { display:flex; flex-direction:column; gap:12px; }

/* Chart card */
.chart-card { padding:14px; border-radius:12px; background: linear-gradient(180deg,#ffffffee,#f7fbffcc); border:1px solid rgba(255,255,255,0.6); }
.chart-controls { display:flex; gap:8px; align-items:center; margin-top:8px; }

/* Details / indicators */
.details { display:flex; gap:12px; margin-top:8px; flex-wrap:wrap; }
.detail-pill {
  background:linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
  padding:8px 12px; border-radius:999px; font-size:13px; border:1px solid rgba(255,255,255,0.6);
  box-shadow:0 6px 12px rgba(12,34,56,0.04);
}

/* Table-like list (compact) */
.table {
  margin-top:8px;
  border-radius:10px;
  overflow:hidden;
}
.table .row {
  display:flex; gap:8px; align-items:center; padding:10px; background:linear-gradient(180deg, rgba(255,255,255,0.45), rgba(255,255,255,0.35)); border-bottom:1px solid rgba(255,255,255,0.6);
}
.row.alt { background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.42)); }
.row .col { flex:1; font-size:13px; color: #0f1724; }
.row .col.small { flex:0 0 90px; text-align:right; }

/* bottom fixed nav (like screenshot) */
.bottom-nav {
  position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:999;
  background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(240,248,255,0.8));
  border-radius:28px; padding:8px 12px; display:flex; gap:8px; box-shadow:0 10px 30px rgba(12,34,56,0.08); border:1px solid rgba(255,255,255,0.55);
}
.bottom-nav button { background:transparent; border:none; padding:8px 12px; border-radius:10px; font-weight:700; color:#083; cursor:pointer; }

/* popup */
.popup {
  position:fixed; right:22px; top:22px; z-index:1500;
  min-width:220px; padding:12px; border-radius:10px; color:#fff; font-weight:700;
  background:linear-gradient(90deg,var(--accent-1),var(--accent-2));
  box-shadow:0 10px 30px rgba(12,34,56,0.18);
  transform:translateY(-8px); opacity:0; animation:popupIn .45s forwards;
}
@keyframes popupIn{ to{ transform:translateY(0); opacity:1 } }

/* responsive */
@media (max-width:1000px){
  .grid{ grid-template-columns: 1fr; }
  .left{ order:2 } .right{ order:1 }
  .bottom-nav{ left:12px; transform:none; }
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">
      <h1>Dashboard Boursier — Premium</h1>
      <p>Interface style glassmorphism + touches trader — prix en temps réel et mini-indicateurs</p>
      <div class="stats" id="topStats">
        <!-- stats injected -->
      </div>
    </div>
    <div style="width:220px; text-align:right;">
      <div style="margin-bottom:8px; font-size:13px; color:var(--muted)">Compte</div>
      <div style="background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:white; padding:10px 12px; border-radius:10px; font-weight:700; box-shadow:0 6px 18px rgba(58,163,255,0.2);">Premium</div>
    </div>
  </div>

  <div class="controls" style="margin-bottom:8px;">
    <input id="searchInput" placeholder="Recherche (ticker, nom) — ex: AAPL, TSLA..." />
    <select id="regionSelect"><option>Toutes bourses</option><option>NASDAQ</option><option>NYSE</option><option>TSX</option></select>
    <select id="sortSelect"><option value="market">Tendance</option><option value="gainers">Top Gainers</option><option value="losers">Top Losers</option></select>
    <button onclick="refreshAll()">Actualiser</button>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="left">
      <div class="card">
        <div class="watchlist-header">
          <div><strong>Watchlist</strong><div style="font-size:12px;color:var(--muted)">Tickers suivis</div></div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="addTickerInput" placeholder="Ajouter ticker..." style="padding:8px;border-radius:8px;border:1px solid #e6eef8" />
            <button onclick="addTickerFromInput()">Ajouter</button>
          </div>
        </div>
        <div class="watchlist-list" id="watchlistList">
          <!-- tickers injected here -->
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><strong>Alertes</strong><div style="font-size:12px;color:var(--muted)">Recevoir notification</div></div>
          <div>
            <input id="alertTicker" placeholder="Ticker" style="width:80px;padding:6px;border-radius:6px" />
            <input id="alertPrice" placeholder="Prix" type="number" style="width:80px;padding:6px;border-radius:6px" />
            <button onclick="createAlert()">Créer</button>
          </div>
        </div>
        <div id="alertsList" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right">
      <div class="chart-card card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><strong id="chartTitle">Sélectionner un ticker</strong><div style="font-size:13px;color:var(--muted)">Clique sur "Voir" dans la watchlist</div></div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="rangeSelect"><option value="1d">1J</option><option value="5d">5J</option><option value="1mo" selected>1M</option><option value="6mo">6M</option><option value="1y">1A</option></select>
            <button onclick="toggleChartType()">Toggle</button>
            <button onclick="startRealtime()">Live</button>
          </div>
        </div>

        <canvas id="mainChart" style="margin-top:10px; width:100%; height:360px;"></canvas>

        <div class="chart-controls" style="margin-top:8px;">
          <div class="details" id="indicatorPills">
            <!-- indicator pills -->
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <strong>Résumé marché</strong>
        <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap">
          <div class="detail-pill">Volatilité: <span id="sumVol">-</span></div>
          <div class="detail-pill">Gainers: <span id="gainersCount">-</span></div>
          <div class="detail-pill">Losers: <span id="losersCount">-</span></div>
          <div class="detail-pill">Indices: S&P500 ▲ Nasdaq</div>
        </div>

        <div class="table" id="tableList" style="margin-top:12px;">
          <!-- dynamic rows -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- bottom nav -->
<div class="bottom-nav">
  <button onclick="setMode('debutant')">Débutant</button>
  <button onclick="setMode('pro')">Pro</button>
  <button onclick="refreshAll()">Rafraîchir</button>
  <button onclick="downloadCSV()">Exporter</button>
</div>

<!-- popup container -->
<div id="popupContainer"></div>

<script>
/* ===========================
   Data & Helpers
   =========================== */
const PROXY = 'https://api.allorigins.win/raw?url=';
const API_QUOTE = s => `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(s)}`;
const API_CHART = (s, range='1mo') => `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(s)}?range=${range}&interval=1d`;

let state = {
  watchlist: ['AAPL','TSLA','NVDA','MSFT','AMZN'],
  alerts: [],
  lastPrices: {}, // keep last known for animation
  chartType: 'line',
  liveInterval: null
};

/* Small util to create DOM */
function el(tag, attrs={}, children=[]){
  const d=document.createElement(tag);
  for(const k in attrs) {
    if(k==='cls') d.className = attrs[k];
    else if(k==='html') d.innerHTML = attrs[k];
    else d.setAttribute(k, attrs[k]);
  }
  if(typeof children === 'string') d.textContent = children;
  else (children||[]).forEach(c => d.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
  return d;
}

/* Formatters */
function fmtN(n){ if(n==null) return '--'; return (n>=1000? (n/1000).toFixed(1)+'k' : n.toFixed(2)); }
function fmtInt(n){ if(n==null) return '--'; return n.toLocaleString(); }

/* ===========================
   UI Render
   =========================== */

function renderTopStats(){
  const container = document.getElementById('topStats');
  container.innerHTML='';
  const cards = [
    {label:'Tickers suivis', value: state.watchlist.length, sub:'Watchlist active'},
    {label:'Alertes', value: state.alerts.length, sub:'Alertes configurées'},
    {label:'Gainers', value: document.getElementById('gainersCount').textContent || 0, sub:'Top aujourd\'hui'},
    {label:'Losers', value: document.getElementById('losersCount').textContent || 0, sub:'Top aujourd\'hui'},
    {label:'Dernière MAJ', value: new Date().toLocaleTimeString(), sub:'Heure locale'}
  ];
  cards.forEach(c => {
    const card = el('div',{cls:'stat-card'},[]);
    card.innerHTML = `<div class="label">${c.label}</div><div class="value">${c.value}</div><div class="sub">${c.sub}</div>`;
    container.appendChild(card);
  });
}

/* Render watchlist items with mini-sparkline */
async function renderWatchlist(){
  const list = document.getElementById('watchlistList');
  list.innerHTML='';
  for(const t of state.watchlist){
    const node = el('div',{cls:'ticker-item'});
    const left = el('div',{cls:'ticker-main'});
    const sym = el('div',{cls:'ticker-symbol'},t);
    const priceSpan = el('div',{cls:'ticker-price'},'--');
    const meta = el('div',{cls:'ticker-meta'},'Chargement...');
    left.append(sym, priceSpan, meta);

    const right = el('div',{cls:'ticker-actions'});
    const btn = el('button',{},'Voir');
    btn.onclick = ()=> loadChartFor(t);
    right.append(btn);

    // sparkline canvas
    const spark = el('canvas',{cls:'spark'});
    spark.width = 100; spark.height = 28;
    right.append(spark);

    node.append(left,right);
    list.appendChild(node);

    // fetch quote & small chart
    fetch(PROXY + encodeURIComponent(API_QUOTE(t))).then(r=>r.json()).then(data=>{
      const q = data?.quoteResponse?.result?.[0];
      if(!q) return;
      const price = q.regularMarketPrice;
      const ch = q.regularMarketChangePercent;
      priceSpan.textContent = (price!=null ? price.toFixed(2)+' €' : '--');
      priceSpan.style.color = ch>0 ? 'var(--success)' : (ch<0 ? 'var(--danger)' : '#333');
      meta.textContent = `O:${fmtN(q.regularMarketOpen)} • H:${fmtN(q.regularMarketDayHigh)} • L:${fmtN(q.regularMarketDayLow)} • V:${fmtInt(q.regularMarketVolume)}`;
      // animate flash
      const prev = state.lastPrices[t];
      if(prev!=null){
        if(price>prev) priceSpan.animate([{transform:'translateY(0)'},{transform:'translateY(-4px)'},{transform:'translateY(0)'}], {duration:300});
        else if(price<prev) priceSpan.animate([{transform:'translateY(0)'},{transform:'translateY(4px)'},{transform:'translateY(0)'}], {duration:300});
      }
      state.lastPrices[t] = price;

      // tiny spark: fetch chart data
      fetch(PROXY + encodeURIComponent(API_CHART(t,'5d'))).then(rr=>rr.json()).then(j=>{
        try{
          const res=j.chart.result[0];
          const closes = res.indicators.quote[0].close.slice(-20);
          renderSparkline(spark, closes);
        }catch(e){}
      });
    }).catch(()=>{ priceSpan.textContent='--'; meta.textContent='—'; });
  }
}

/* Render sparkline small */
function renderSparkline(canvas, data){
  const ctx = canvas.getContext('2d');
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  if(!data || data.length===0) return;
  const min = Math.min(...data.filter(x=>x!=null));
  const max = Math.max(...data.filter(x=>x!=null));
  ctx.lineWidth=2;
  ctx.beginPath();
  data.forEach((v,i)=>{
    if(v==null) return;
    const x = i*(w/(data.length-1));
    const y = h - ((v-min)/(max-min))*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = (data[data.length-1] >= data[0]) ? 'rgba(45,211,111,0.95)' : 'rgba(255,107,107,0.95)';
  ctx.stroke();
}

/* Chart (main) */
let mainChart = null;
async function loadChartFor(symbol){
  document.getElementById('chartTitle').textContent = symbol;
  try{
    const res = await fetch(PROXY + encodeURIComponent(API_CHART(symbol, document.getElementById('rangeSelect').value)));
    const j = await res.json();
    const r = j.chart.result[0];
    const timestamps = r.timestamp.map(ts=>new Date(ts*1000).toLocaleDateString());
    const closes = r.indicators.quote[0].close;
    const opens = r.indicators.quote[0].open;
    const highs = r.indicators.quote[0].high;
    const lows = r.indicators.quote[0].low;

    const ctx = document.getElementById('mainChart').getContext('2d');
    if(mainChart) mainChart.destroy();

    if(state.chartType === 'line'){
      mainChart = new Chart(ctx, {
        type: 'line',
        data: { labels: timestamps, datasets:[{label:symbol, data:closes, borderColor: 'rgba(58,163,255,0.95)', backgroundColor:'rgba(58,163,255,0.12)', tension:0.25}]},
        options: { responsive:true, plugins:{legend:{display:false}} }
      });
    } else {
      const ohlc = opens.map((o,i)=>({x:timestamps[i], o:o, h:highs[i], l:lows[i], c:closes[i]}));
      mainChart = new Chart(ctx, {
        type: 'candlestick',
        data: { datasets:[{label:symbol, data:ohlc}]},
        options:{ responsive:true, plugins:{legend:{display:false}} }
      });
    }

    // update details pills
    document.getElementById('indicatorPills').innerHTML = '';
    document.getElementById('indicatorPills').appendChild(el('div',{cls:'detail-pill'},`Dernier: ${closes.slice(-1)[0]?.toFixed(2)||'--'} €`));
    document.getElementById('indicatorPills').appendChild(el('div',{cls:'detail-pill'},`Open: ${opens.slice(-1)[0]?.toFixed(2)||'--'} €`));
    document.getElementById('indicatorPills').appendChild(el('div',{cls:'detail-pill'},`High: ${highs.slice(-1)[0]?.toFixed(2)||'--'} €`));
    document.getElementById('indicatorPills').appendChild(el('div',{cls:'detail-pill'},`Low: ${lows.slice(-1)[0]?.toFixed(2)||'--'} €`));
  }catch(e){
    console.warn('chart error', e);
    alert('Impossible de charger le graphique pour '+symbol);
  }
}

/* Table list (compact) */
function renderTableList(){
  const table = document.getElementById('tableList');
  table.innerHTML='';
  let alt=false;
  state.watchlist.forEach(t=>{
    const row = el('div',{cls:'row'+(alt?' alt':'')});
    row.innerHTML = `<div class="col"><strong>${t}</strong></div>
      <div class="col small" id="row-price-${t}">--</div>
      <div class="col small" id="row-change-${t}">--</div>
      <div class="col small"> <button onclick="loadChartFor('${t}')">Voir</button> </div>`;
    table.appendChild(row);
    alt = !alt;
  });
}

/* Alerts */
function createAlert(){
  const t = document.getElementById('alertTicker').value.trim().toUpperCase();
  const p = parseFloat(document.getElementById('alertPrice').value);
  if(!t || !p){ alert('Remplir ticker + prix'); return; }
  state.alerts.push({ticker:t, price:p, triggered:false});
  document.getElementById('alertTicker').value=''; document.getElementById('alertPrice').value='';
  renderAlertsUI();
}
function renderAlertsUI(){
  const elist = document.getElementById('alertsList');
  elist.innerHTML='';
  state.alerts.forEach((a,i)=>{
    const node = el('div',{cls:'alert-item'},[
      el('div',{},`${a.ticker} ${a.price} €`),
      el('div',{}, el('button',{}, 'Suppr'))
    ]);
    node.querySelector('button').onclick = ()=>{ state.alerts.splice(i,1); renderAlertsUI(); };
    elist.appendChild(node);
  });
}

/* Popup */
function showPopup(text, important=false){
  const p = el('div',{cls:'popup'}, text);
  if(important) p.style.background = 'linear-gradient(90deg,var(--danger),#ff9b9b)';
  document.getElementById('popupContainer').appendChild(p);
  setTimeout(()=> p.remove(), 4200);
}

/* LIVE update prices & check alerts */
async function refreshAll(){
  // update watchlist quick quotes and table rows
  for(const t of state.watchlist){
    try{
      const res = await fetch(PROXY + encodeURIComponent(API_QUOTE(t)));
      const data = await res.json();
      const q = data.quoteResponse?.result?.[0];
      if(!q) continue;
      const price = q.regularMarketPrice;
      const ch = q.regularMarketChangePercent;
      // update small row if exists
      const rowPrice = document.getElementById('row-price-'+t);
      if(rowPrice) rowPrice.textContent = (price!=null? price.toFixed(2)+' €' : '--');
      const rowCh = document.getElementById('row-change-'+t);
      if(rowCh) { rowCh.textContent = (ch!=null? ch.toFixed(2)+'%': '--'); rowCh.style.color = ch>0?'var(--success)':(ch<0?'var(--danger)':'#333'); }
      // alerts
      state.alerts.forEach(a=>{
        if(!a.triggered && a.ticker===t){
          if((a.price <= price && a.direction!=='below') || (a.price >= price && a.direction!=='above')){
            showPopup(`Alerte ${t}: ${price} €`, true);
            a.triggered = true;
          }
        }
      });
    }catch(e){}
  }
  renderTopStats();
  renderWatchlist();
  renderTableList();
}

/* Helpers */
function addTickerFromInput(){
  const v = document.getElementById('addTickerInput').value.trim().toUpperCase();
  if(!v) return;
  if(!state.watchlist.includes(v)) state.watchlist.push(v);
  document.getElementById('addTickerInput').value='';
  renderWatchlist(); renderTableList();
}

/* Chart type toggle */
function toggleChartType(){ state.chartType = (state.chartType==='line'?'candlestick':'line'); loadChartFor(document.getElementById('chartTitle').textContent || state.watchlist[0]); }

/* Live stream (naive polling) */
function startRealtime(){
  if(state.liveInterval){ clearInterval(state.liveInterval); state.liveInterval=null; showPopup('Live stoppé'); return; }
  state.liveInterval = setInterval(refreshAll, 5000);
  showPopup('Live démarré — rafraîchissement 5s');
}

/* Export CSV (basic) */
function downloadCSV(){
  let rows = [['Ticker','Price','Change%']];
  const promises = state.watchlist.map(async t=>{
    try{
      const r = await fetch(PROXY + encodeURIComponent(API_QUOTE(t)));
      const j = await r.json(); const q = j.quoteResponse.result[0];
      rows.push([t, q.regularMarketPrice || '', q.regularMarketChangePercent || '']);
    }catch(e){ rows.push([t,'','']); }
  });
  Promise.all(promises).then(()=>{
    const csv = rows.map(r=> r.map(c=> `"${c}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='watchlist.csv'; a.click(); URL.revokeObjectURL(url);
  });
}

/* Init */
renderTopStats();
renderWatchlist();
renderTableList();
renderAlertsUI();

// periodic refresh every 10s
setInterval(refreshAll, 10000);
refreshAll();

</script>
</body>
</html>
