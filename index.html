<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard Boursier â€” Desktop Glass Pro</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.0.0/dist/chartjs-chart-financial.min.js"></script>

<style>
/* ====================
   CSS: MISE EN PAGE ET STYLES
   ==================== */
:root {
Â  Â  /* Nouvelle Palette de Couleurs */
Â  Â  --primary: #2c776e;Â  Â  Â  /* Vert-bleu foncÃ© (professionnel) */
Â  Â  --accent: #4CAF50;Â  Â  Â  Â /* Vert pour la hausse */
Â  Â  --danger: #f44336;Â  Â  Â  Â /* Rouge pour la baisse */
Â  Â  --bg-light: #f9fbfd;Â  Â  Â /* Fond trÃ¨s clair */
Â  Â  --shadow-soft: 0 4px 12px rgba(0,0,0,0.08); /* Ombre douce */
Â  Â  --text-muted: #6b7280;Â  Â /* Gris pour les textes secondaires */
Â  Â  --card-radius: 12px;
Â  Â  font-family: 'Roboto', Arial, sans-serif; /* Police claire et lisible */
}

body {
Â  Â  font-family: var(--font-family);
Â  Â  background-color: var(--bg-light);
Â  Â  background: linear-gradient(180deg, var(--bg-light), #e6f0f2); /* DÃ©gradÃ© doux */
Â  Â  margin: 0;
Â  Â  padding: 20px;
Â  Â  color: #1f2937; /* Texte trÃ¨s foncÃ© */
}
.container{
Â  Â  max-width: 1400px;
Â  Â  margin: 0 auto;
}

/* ------------------------------------- */
/* --- BOUTONS / INPUTS --- */
/* ------------------------------------- */

button, .btn {
Â  Â  padding: 8px 12px;
Â  Â  margin-left: 5px;
Â  Â  cursor: pointer;
Â  Â  border-radius: 6px;
Â  Â  border: 1px solid #ccc;
Â  Â  background-color: #fff;
Â  Â  transition: all 0.2s;
Â  Â  font-weight: 600;
}
button:hover, .btn:hover {
Â  Â  background-color: #e0e0e0;
Â  Â  border-color: #9ca3af;
}

/* Boutons d'action principale */
.btn.primary {
Â  Â  background: var(--primary);
Â  Â  color: white;
Â  Â  border: none;
}
.btn.primary:hover {
Â  Â  background: #1e5a51;
}

.controls input, .controls select, .small-input {
Â  Â  padding: 8px 10px;
Â  Â  border-radius: 6px;
Â  Â  border: 1px solid #ccc;
Â  Â  background-color: white;
}

/* ------------------------------------- */
/* --- MISE EN PAGE / SECTIONS --- */
/* ------------------------------------- */

.grid {
Â  Â  display: grid;
Â  Â  grid-template-columns: 360px 1fr;
Â  Â  gap: 24px; /* AugmentÃ© l'espacement pour l'aÃ©ration */
Â  Â  margin-top: 24px;
Â  Â  align-items: start;
}
@media (max-width:1100px){
Â  Â  .grid{ grid-template-columns:1fr; }
}
.left{ order:1; } 
.right{ order:2; }

.section, .chart-card, .panel {
Â  Â  background: white;
Â  Â  padding: 20px; /* AugmentÃ© le padding pour l'aÃ©ration */
Â  Â  margin: 0;
Â  Â  border-radius: var(--card-radius);
Â  Â  box-shadow: var(--shadow-soft); /* Ombre douce */
Â  Â  border: 1px solid #e5e7eb; /* Bordure lÃ©gÃ¨re */
}

/* ------------------------------------- */
/* --- WATCHLIST STYLING --- */
/* ------------------------------------- */

.ticker-item {
Â  Â  background: #fcfcfc;
Â  Â  padding: 12px;
Â  Â  margin: 8px 0;
Â  Â  border-radius: 8px;
Â  Â  border: 1px solid #f3f4f6;
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  cursor: pointer;
Â  Â  transition: transform 0.2s, box-shadow 0.2s;
}
.ticker-item:hover {
Â  Â  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
Â  Â  transform: translateY(-1px);
}

/* COULEURS DES DONNÃ‰ES */
.ticker-item.up { border-left: 6px solid var(--accent); }Â 
.ticker-item.down { border-left: 6px solid var(--danger); }Â 
.ticker-price.up { color: #05603a !important; font-weight: 700; font-size: 1.1em; } 
.ticker-price.down { color: #7f1d1d !important; font-weight: 700; font-size: 1.1em; } 
.ticker-meta {
Â  Â  font-size: 12px;
Â  Â  color: var(--text-muted);
}
.ticker-symbol {
Â  Â  font-size: 16px;
Â  Â  font-weight: 800;
}

/* Pop-up Alerte (AmÃ©liorÃ©) */
.popup {
Â  Â  position:fixed;
Â  Â  right:22px;
Â  Â  bottom:22px;
Â  Â  z-index:1500;
Â  Â  min-width:280px;
Â  Â  padding:14px;
Â  Â  border-radius:10px;
Â  Â  background:linear-gradient(90deg, var(--accent), #10b981);
Â  Â  color:white;
Â  Â  font-weight:700;
Â  Â  box-shadow:var(--shadow-soft);
}
</style>
</head>

<body>
<div class="container">
Â  Â  <div style="display:flex;justify-content:flex-end;gap:12px;align-items:center;padding:0 20px 20px 0;">
Â  Â  <select id="currencySelect" class="small-input" onchange="state.currency = this.value; refreshAll(); loadChartFor(document.getElementById('chartTitle').textContent.split(' ')[0])">
Â  Â  Â  <option value="EUR">â‚¬ EUR</option>
Â  Â  Â  <option value="USD">$ USD</option>
Â  Â  Â  <option value="CAD">$ CAD</option>
Â  Â  </select>
Â  Â  <select id="rangeSelect" class="small-input" onchange="loadChartFor(document.getElementById('chartTitle').textContent.split(' ')[0])">
Â  Â  Â  <option value="1mo">1 Mois</option>
Â  Â  Â  <option value="3mo">3 Mois</option>
Â  Â  Â  <option value="6mo">6 Mois</option>
Â  Â  Â  <option value="1y">1 An</option>
Â  Â  </select>
Â  </div>
Â  
Â  <div class="grid">
Â  Â  Â  Â  <div class="left">
Â  Â  Â  <div class="section">Â  Â  Â  Â  Â  
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  Â  <div><strong>Watchlist</strong><div style="font-size:12px;color:var(--text-muted)">Tout est mis Ã  jour automatiquement</div></div>
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  Â  Â  <input id="addTickerInput" placeholder="Ajouter (ex: AAPL)" class="small-input">
Â  Â  Â  Â  Â  Â  <button class="btn" onclick="addTickerFromInput()">Ajouter</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="watchlist-list" id="watchlistList"></div>
Â  Â  Â  </div>
Â  Â  Â  
Â  Â  Â  <div class="section" style="margin-top:12px">
Â  Â  Â  Â  <strong>Alertes & Paper-trade</strong>
Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:10px">
Â  Â  Â  Â  Â  <input id="alertTicker" placeholder="Ticker" class="small-input" style="width:90px">
Â  Â  Â  Â  Â  <input id="alertPrice" placeholder="Prix" type="number" class="small-input" style="width:110px">
Â  Â  Â  Â  Â  <select id="alertDir" class="small-input" style="width:110px"><option value="above">Au-dessus</option><option value="below">En-dessous</option></select>
Â  Â  Â  Â  Â  <button class="btn" onclick="createAlert()">CrÃ©er</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="alertsList" style="margin-top:12px"></div>

Â  Â  Â  Â  <div style="margin-top:12px;border-top:1px dashed rgba(0,0,0,0.04);padding-top:12px">
Â  Â  Â  Â  Â  <strong>Calculatrice taille position</strong>
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
Â  Â  Â  Â  Â  Â  <input id="accountSize" placeholder="Capital" type="number" class="small-input" style="width:120px">
Â  Â  Â  Â  Â  Â  <input id="riskPct" placeholder="% risque" type="number" class="small-input" style="width:100px">
Â  Â  Â  Â  Â  Â  <input id="stopDist" placeholder="Stop (â‚¬)" type="number" class="small-input" style="width:110px">
Â  Â  Â  Â  Â  Â  <button class="btn" onclick="calculatePosition()">Calculer</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="positionResult" style="margin-top:8px;font-weight:800"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px;border-top:1px dashed rgba(0,0,0,0.04);padding-top:12px">
Â  Â  Â  Â  Â  <strong>Paper-trade</strong>
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  Â  Â  Â  <input id="ptTicker" placeholder="Ticker" class="small-input" style="width:100px">
Â  Â  Â  Â  Â  Â  <input id="ptQty" placeholder="Qty" type="number" class="small-input" style="width:80px">
Â  Â  Â  Â  Â  Â  <input id="ptPrice" placeholder="Price" type="number" class="small-input" style="width:100px">
Â  Â  Â  Â  Â  Â  <button class="btn" onclick="addPaperTrade()">Ajouter</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="paperTradesList" style="margin-top:10px;max-height:140px;overflow:auto"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="section" style="margin-top:12px">
Â  Â  Â  Â  <strong>OpportunitÃ©s & Scanner</strong>
Â  Â  Â  Â  <div id="scannerList" style="margin-top:8px;color:var(--text-muted)">Chargement...</div>
Â  Â  Â  Â  <div style="margin-top:8px" class="heatmap" id="heatmap"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="right">
Â  Â  Â  <div class="chart-card panel">
Â  Â  Â  Â  <div class="chart-head" style="display:flex;justify-content:space-between;align-items:center;">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <strong id="chartTitle">SÃ©lectionner un ticker</strong>
Â  Â  Â  Â  Â  Â  <div style="font-size:12px;color:var(--text-muted)">Toutes les donnÃ©es s'affichent ici automatiquement</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  Â  Â  <select id="chartTypeSelect" class="small-input" onchange="switchChartType(this.value)">
Â  Â  Â  Â  Â  Â  Â  <option value="line">Ligne</option>
Â  Â  Â  Â  Â  Â  Â  <option value="candlestick">Chandelier</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  <button class="btn ghost" onclick="toggleRealtime()">Start/Stop Live</button>
Â  Â  Â  Â  Â  Â  <button class="btn" onclick="downloadCSV()">Exporter</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="mainChart" style="margin-top:12px;width:100%;height:420px;background:transparent"></canvas>
Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div id="rsiContainer" style="margin-top:15px;padding-top:10px;border-top:1px dashed #e0e0e0;">
Â  Â  Â  Â  Â  <canvas id="rsiChart" style="width:100%;height:100px;background:transparent"></canvas>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="chart-controls" style="margin-top:10px">
Â  Â  Â  Â  Â  <div id="indicatorPills" style="display:flex;gap:8px"></div>
Â  Â  Â  Â  Â  <div style="margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(90deg,rgba(125,211,166,0.08),rgba(96,165,250,0.03));border:1px solid rgba(0,0,0,0.02)">
Â  Â  Â  Â  Â  Â  <strong>Conseil automatique (dÃ©butant)</strong>
Â  Â  Â  Â  Â  Â  <div id="autoAdvice" style="margin-top:8px;color:#064233;font-weight:800">Aucune action sÃ©lectionnÃ©e.</div>
Â  Â  Â  Â  Â  Â  <div style="margin-top:8px"><small style="color:var(--text-muted)">BasÃ© sur RSI, MA20/50, volume, news.</small></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="panel" style="margin-top:12px">
Â  Â  Â  Â  <strong>DonnÃ©es & News (automatique)</strong>
Â  Â  Â  Â  <div style="display:flex;gap:12px;margin-top:8px">
Â  Â  Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  Â  Â  <h4 style="margin:6px 0;color:#082033">DonnÃ©es complÃ¨tes</h4>
Â  Â  Â  Â  Â  Â  <div id="fundamentals" style="color:var(--text-muted)">SÃ©lectionne une action pour voir toutes les mÃ©triques (P/E, Market Cap, Volume...)</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  Â  Â  <h4 style="margin:6px 0;color:#082033">ActualitÃ©s</h4>
Â  Â  Â  Â  Â  Â  <div id="newsFeed" style="max-height:220px;overflow:auto;padding-right:6px;color:var(--text-muted)">Chargement news...</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â <div style="margin-top:12px" class="table" id="tableList"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="bottom-actions">
Â  Â  <button class="quick-btn" onclick="showPopup('Raccourci : add AAPL, puis Voir')">?</button>
Â  </div>

Â  <div id="popupContainer"></div>
Â  <div id="onboarding" class="modal-bg" style="display:none"><div class="modal">
Â  Â  <h2>Guide rapide</h2>
Â  Â  <ol>
Â  Â  Â  <li>Ajouter un ticker â†’ Cliquez "Voir" dans la watchlist.</li>
Â  Â  Â  <li>Le panneau de droite affiche le graphique, indicateurs, conseils et news.</li>
Â  Â  Â  <li>Active Live pour actualiser toutes les 5s.</li>
Â  Â  </ol>
Â  Â  <div style="margin-top:12px"><button class="btn" onclick="closeOnboarding()">OK</button></div>
Â  </div></div>
</div>

<script>
/* ====================
Â  Â JAVASCRIPT: LOGIQUE DU DASHBOARD
Â  Â ==================== */
const PROXY = 'https://api.allorigins.win/raw?url=';
const API_QUOTE = s => `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(s)}`;
const API_CHART = (s, range='1mo') => `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(s)}?range=${range}&interval=1d`;
const NEWS_SOURCES = [
Â  'https://finance.yahoo.com/news/rssindex',
Â  'https://www.reuters.com/business/finance/rss',
Â  'https://www.investing.com/rss/news.rss'
];

let state = {
Â  watchlist: JSON.parse(localStorage.getItem('watchlist')) || ['AAPL','TSLA','NVDA','MSFT','AMZN'],
Â  alerts: JSON.parse(localStorage.getItem('alerts')) || [],
Â  paperTrades: JSON.parse(localStorage.getItem('paperTrades')) || [],
Â  lastPrices: {},
Â  chartType: 'line',
Â  liveInterval: null,
Â  currency: 'EUR', 
Â  currentTicker: null, 
Â  currentRange: '1mo' 
};

function el(tag, attrs={}, children=[]){
Â  const d=document.createElement(tag);
Â  if(attrs.cls) d.className = attrs.cls;
Â  if(attrs.html) d.innerHTML = attrs.html;
Â  if(attrs.text) d.textContent = attrs.text;
Â  for(const k in attrs) if(!['cls','html','text'].includes(k)) d.setAttribute(k, attrs[k]);
Â  (Array.isArray(children)?children:[children]).forEach(c=>{ if(!c) return; d.appendChild(typeof c==='string'?document.createTextNode(c):c) });
Â  return d;
}
function fmt(n){ if(n==null||isNaN(n)) return '--'; return Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtShort(n){ if(n==null||isNaN(n)) return '--'; if(n>=1e12) return (n/1e12).toFixed(2)+'T'; if(n>=1e9) return (n/1e9).toFixed(2)+'B'; if(n>=1e6) return (n/1e6).toFixed(2)+'M'; if(n>=1e3) return (n/1e3).toFixed(2)+'k'; return n.toFixed(2); }

/* Watchlist rendering */
async function renderWatchlist(){
Â  const list = document.getElementById('watchlistList'); list.innerHTML='';
Â  for(const symbol of state.watchlist){
Â  Â  const item = el('div',{cls:'ticker-item'});
Â  Â  const left = el('div',{cls:'ticker-left'});
Â  Â  const sym = el('div',{cls:'ticker-symbol', text:symbol});
Â  Â  const priceSpan = el('div',{cls:'ticker-price', text:'--'});
Â  Â  const meta = el('div',{cls:'ticker-meta', text:'Chargement...'});
Â  Â  left.append(sym, priceSpan, meta);

Â  Â  const right = el('div',{style:'display:flex;flex-direction:column;align-items:flex-end;gap:6px'});
Â  Â  const seeBtn = el('button',{cls:'btn ghost'},'Voir'); seeBtn.onclick = ()=> loadChartFor(symbol);
Â  Â  const addAlertBtn = el('button',{cls:'btn ghost'},'Alerte'); addAlertBtn.onclick = ()=> { document.getElementById('alertTicker').value=symbol; };
Â  Â  const delBtn = el('button',{cls:'btn ghost', style:'color:var(--danger)'}, 'Suppr'); delBtn.onclick = () => {
Â  Â  Â  state.watchlist = state.watchlist.filter(t => t !== symbol);
Â  Â  Â  storeState();
Â  Â  Â  refreshAll();
Â  Â  };
Â  Â  right.append(seeBtn, addAlertBtn, delBtn);

Â  Â  item.append(left,right);
Â  Â  list.appendChild(item);

Â  Â  // fetch quote (non-blocking)
Â  Â  fetch(PROXY + encodeURIComponent(API_QUOTE(symbol))).then(r=>r.json()).then(data=>{
Â  Â  Â  const q = data?.quoteResponse?.result?.[0];
Â  Â  Â  if(!q) return;
Â  Â  Â  const price = q.regularMarketPrice;
Â  Â  Â  const ch = q.regularMarketChangePercent;
Â  Â  Â  priceSpan.textContent = (price!=null ? formatCurrency(price) : '--');
Â  Â  Â  priceSpan.className = 'ticker-price ' + (ch>0 ? 'up' : (ch < 0 ? 'down' : ''));
Â  Â  Â  item.className = 'ticker-item ' + (ch>0 ? 'up' : (ch < 0 ? 'down' : ''));
Â  Â  Â  meta.textContent = `H:${fmtShort(q.regularMarketDayHigh)} L:${fmtShort(q.regularMarketDayLow)} â€¢ V:${fmtShort(q.regularMarketVolume)}`;
Â  Â  Â  state.lastPrices[symbol] = price;
Â  Â  }).catch(()=>{ priceSpan.textContent='--'; meta.textContent='â€”'; item.className='ticker-item'; });
Â  }
}

/* table list */
function renderTableList(){
Â  const table = document.getElementById('tableList'); table.innerHTML='<div style="font-weight:600;display:flex;justify-content:space-between;border-bottom:1px solid #e0e0e0;padding-bottom:5px"><div style="width:100px">Ticker</div><div>Prix</div><div>% Change</div><div>Action</div></div>';
Â  state.watchlist.forEach(symbol=>{
Â  Â  const row = el('div',{style:'display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(0,0,0,0.05)'});
Â  Â  row.innerHTML = `<div style="width:100px"><strong>${symbol}</strong></div>
Â  Â  Â  <div><span id="row-price-${symbol}">--</span></div>
Â  Â  Â  <div><span id="row-change-${symbol}">--</span></div>
Â  Â  Â  <div><button class="btn ghost" onclick="loadChartFor('${symbol}')">Voir</button></div>`;
Â  Â  table.appendChild(row);
Â  });
}

/* alerts & paper */
function renderAlertsUI(){ 
Â  const elist=document.getElementById('alertsList'); elist.innerHTML=''; 
Â  state.alerts.forEach((a,i)=>{ 
Â  Â  const node=el('div',{cls:'ticker-item', style:'padding:8px;margin:4px 0;', html:`<div><strong>${a.ticker}</strong> ${a.direction==='above'?'ðŸ“ˆ >':'ðŸ“‰ <'} ${formatCurrency(a.price)}</div>`}); 
Â  Â  const d=el('button',{cls:'btn ghost', style:'padding:4px 8px;'},'Suppr'); 
Â  Â  d.onclick=()=>{ state.alerts.splice(i,1); storeState(); renderAlertsUI(); }; 
Â  Â  node.style.justifyContent='space-between';
Â  Â  node.appendChild(d); 
Â  Â  elist.appendChild(node); 
Â  }); 
}

function renderPaperTrades(){ 
Â  const out=document.getElementById('paperTradesList'); out.innerHTML=''; 
Â  state.paperTrades.forEach((t,i)=>{ 
Â  Â  const div=el('div',{cls:'ticker-item', style:'padding:8px;margin:4px 0;', html:`<div><strong>${t.ticker}</strong> â€¢ ${t.qty} @ ${formatCurrency(t.price)}</div>`}); 
Â  Â  const del=el('button',{cls:'btn ghost', style:'padding:4px 8px;'},'Vendu'); 
Â  Â  del.onclick=()=>{ 
Â  Â  Â  if(confirm(`Voulez-vous clÃ´turer ${t.ticker}?`)){
Â  Â  Â  Â  state.paperTrades.splice(i,1); storeState(); renderPaperTrades(); 
Â  Â  Â  Â  showPopup(`Trade ${t.ticker} clÃ´turÃ© (Paper)`);
Â  Â  Â  }
Â  Â  }; 
Â  Â  div.style.justifyContent='space-between';
Â  Â  div.appendChild(del); 
Â  Â  out.appendChild(div); 
Â  }); 
}

/* ====================
Â  Â CHARTS / INDICATORS / ADVICE
Â  Â ==================== */
let mainChart = null;
let rsiChart = null; 

async function loadChartFor(symbol){
Â  state.currentTicker = symbol;
Â  state.currentRange = document.getElementById('rangeSelect').value;
Â  document.getElementById('chartTitle').textContent = symbol + ' â€¢ Chargement...';
Â  try{
Â  Â  const res = await fetch(PROXY + encodeURIComponent(API_CHART(symbol, state.currentRange)));
Â  Â  const j = await res.json();
Â  Â  const r = j.chart && j.chart.result && j.chart.result[0];
Â  Â  if(!r){ alert('DonnÃ©es graphiques non disponibles'); return; }
Â  Â  const timestamps = r.timestamp.map(ts => new Date(ts*1000).toLocaleDateString()); 
Â  Â  const opens = r.indicators.quote[0].open;
Â  Â  const highs = r.indicators.quote[0].high;
Â  Â  const lows = r.indicators.quote[0].low;
Â  Â  const closes = r.indicators.quote[0].close;

Â  Â  // 1. CALCUL DES INDICATEURS 
Â  Â  const ma20 = movingAverage(closes,20);
Â  Â  const ma50 = movingAverage(closes,50);
Â  Â  const rsiArray = computeRSI(closes,14);
Â  Â  const rsi = rsiArray.slice(-1)[0] || null;

Â  Â  // 2. GRAPHIQUE PRINCIPAL
Â  Â  const ctx = document.getElementById('mainChart').getContext('2d');
Â  Â  if(mainChart) mainChart.destroy();

Â  Â  if(state.chartType === 'line'){
Â  Â  Â  const datasets = [
Â  Â  Â  Â  { label: symbol, data: closes, borderColor: '#2f855a', backgroundColor: 'rgba(125,211,166,0.12)', tension:0.2, pointRadius:0, fill:true, order: 3 },
Â  Â  Â  Â  { label: 'MA20', data: ma20, borderColor: '#FFC107', borderWidth: 1.5, tension:0.2, pointRadius:0, fill:false, order: 2 },
Â  Â  Â  Â  { label: 'MA50', data: ma50, borderColor: '#2196F3', borderWidth: 1.5, tension:0.2, pointRadius:0, fill:false, order: 1 }
Â  Â  Â  ];
Â  Â  Â  
Â  Â  Â  mainChart = new Chart(ctx, {
Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  data: { labels: timestamps, datasets: datasets },
Â  Â  Â  Â  options: { 
Â  Â  Â  Â  Â  responsive:true, 
Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  plugins:{ legend:{ display:true, position: 'top' } },
Â  Â  Â  Â  Â  scales: { x: { display: false } }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  const ohlc = opens.map((o,i)=>({x:timestamps[i], o:opens[i], h:highs[i], l:lows[i], c:closes[i]}));
Â  Â  Â  mainChart = new Chart(ctx, { 
Â  Â  Â  Â  type:'candlestick', 
Â  Â  Â  Â  data:{datasets:[{label:symbol, data:ohlc}]}, 
Â  Â  Â  Â  options:{
Â  Â  Â  Â  Â  responsive:true,
Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  plugins:{legend:{display:false}},
Â  Â  Â  Â  Â  scales: { x: { display: false } }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // 3. GRAPHIQUE RSI
Â  Â  const rsiCtx = document.getElementById('rsiChart').getContext('2d');
Â  Â  if(rsiChart) rsiChart.destroy();
Â  Â  
Â  Â  rsiChart = new Chart(rsiCtx, {
Â  Â  Â  type: 'line',
Â  Â  Â  data: {
Â  Â  Â  Â  labels: timestamps,
Â  Â  Â  Â  datasets: [{ 
Â  Â  Â  Â  Â  label: 'RSI (14)', 
Â  Â  Â  Â  Â  data: rsiArray, 
Â  Â  Â  Â  Â  borderColor: '#9C27B0', 
Â  Â  Â  Â  Â  borderWidth: 1.5, 
Â  Â  Â  Â  Â  pointRadius: 0,
Â  Â  Â  Â  Â  fill: false
Â  Â  Â  Â  }]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  plugins: { legend: { display: true, position: 'top' } },
Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  min: 0, max: 100, ticks: { stepSize: 10 },
Â  Â  Â  Â  Â  Â  afterBuildTicks: axis => { axis.ticks.push({ value: 30, label: '30 (Buy)' },{ value: 70, label: '70 (Sell)' }) }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  // 4. PILLS & ADVICE
Â  Â  const pills = document.getElementById('indicatorPills'); pills.innerHTML='';
Â  Â  pills.appendChild(el('div',{cls:'detail-pill', text:`Dernier: ${formatCurrency(closes.slice(-1)[0]||0)}`}));
Â  Â  pills.appendChild(el('div',{cls:'detail-pill', text:`MA20: ${ma20.slice(-1)[0]?ma20.slice(-1)[0].toFixed(2):'--'}`}));
Â  Â  pills.appendChild(el('div',{cls:'detail-pill', text:`MA50: ${ma50.slice(-1)[0]?ma50.slice(-1)[0].toFixed(2):'--'}`}));
Â  Â  pills.appendChild(el('div',{cls:'detail-pill', text:`RSI: ${rsi?Math.round(rsi):'--'}`}));

Â  Â  const advice = analyzeForAdvice({symbol, closes, ma20, ma50, rsi});
Â  Â  document.getElementById('autoAdvice').textContent = advice.text;

Â  Â  // 5. fundamentals + news
Â  Â  loadFundamentals(symbol); loadNewsForTicker(symbol);
Â  Â  document.getElementById('chartTitle').textContent = symbol + ' â€¢ ' + state.currentRange.toUpperCase();

Â  }catch(e){
Â  Â  console.warn(e);
Â  Â  document.getElementById('chartTitle').textContent = symbol + ' â€¢ Erreur de chargement';
Â  Â  alert('Erreur chargement graphique pour ' + symbol);
Â  }
}

function movingAverage(data, period){
Â  const out=[];
Â  for(let i=0;i<data.length;i++){
Â  Â  if(i < period-1){ out.push(null); continue; }
Â  Â  let sum=0, count=0;
Â  Â  for(let j=0;j<period;j++){ const v=data[i-j]; if(v!=null){ sum+=v; count++; } }
Â  Â  out.push(count? sum/count : null);
Â  }
Â  return out;
}

function computeRSI(closes, period=14){
Â  if(!closes || closes.length < period+1) return Array(closes.length).fill(null);
Â  const deltas=[]; for(let i=1;i<closes.length;i++) deltas.push(closes[i]-closes[i-1]);
Â  let seed = deltas.slice(0,period); let up=0,down=0; seed.forEach(s=> s>0? up+=s : down+=Math.abs(s)); up/=period; down/=period;
Â  const rsis=[]; let prevUp=up, prevDown=down;
Â  for(let i=period;i<deltas.length;i++){ const delta=deltas[i]; const u = delta>0?delta:0; const d = delta<0?Math.abs(delta):0;
Â  Â  prevUp = (prevUp*(period-1)+u)/period; prevDown = (prevDown*(period-1)+d)/period; const rs = prevDown===0?100:prevUp/prevDown; const rsi = 100-(100/(1+rs)); rsis.push(rsi);
Â  }
Â  return Array(period).fill(null).concat(rsis);
}

function analyzeForAdvice({symbol, closes, ma20, ma50, rsi}){
Â  let type='neutral', text='Aucune recommandation claire â€” surveille indicateurs & news.';
Â  if(rsi && rsi < 30){ type='buy'; text = `RSI ${Math.round(rsi)} â€” marchÃ© survendu. OpportunitÃ© possible (vÃ©rifier volume/news).`; }
Â  else if(rsi && rsi > 80){ type='sell'; text = `RSI ${Math.round(rsi)} â€” surachetÃ©. Envisager sÃ©curiser gains.`; }
Â  const lastIdx = closes.length-1;
Â  const prevMA20 = ma20[lastIdx-1], prevMA50 = ma50[lastIdx-1], lastMA20 = ma20[lastIdx], lastMA50 = ma50[lastIdx];
Â  if(prevMA20!=null && prevMA50!=null && lastMA20!=null && lastMA50!=null){
Â  Â  if(prevMA20 < prevMA50 && lastMA20 > lastMA50){ type='buy'; text = `Croisement MA20/50 haussier â€” signal acheteur.`; }
Â  Â  if(prevMA20 > prevMA50 && lastMA20 < lastMA50){ type='sell'; text = `Croisement MA20/50 baissier â€” prudence.`; }
Â  }
Â  if(type==='buy') text += ' (dÃ©butant: petite taille, stop serrÃ©).';
Â  if(type==='sell') text += ' (dÃ©butant: sÃ©curiser une partie).';
Â  return {type,text};
}

/* NEWS / FUNDAMENTALS */
async function loadNewsForTicker(ticker){
Â  const out = document.getElementById('newsFeed'); out.innerHTML = 'Recherche news...';
Â  const items = [];
Â  for(const url of NEWS_SOURCES){
Â  Â  try{
Â  Â  Â  const r = await fetch(PROXY + encodeURIComponent(url));
Â  Â  Â  const text = await r.text();
Â  Â  Â  const parser = new DOMParser(); const xml = parser.parseFromString(text,"text/xml");
Â  Â  Â  const rssItems = Array.from(xml.querySelectorAll('item')).slice(0,8);
Â  Â  Â  rssItems.forEach(it=>{
Â  Â  Â  Â  const title = it.querySelector('title')?.textContent || '';
Â  Â  Â  Â  const link = it.querySelector('link')?.textContent || '#';
Â  Â  Â  Â  if(title.toLowerCase().includes(ticker.toLowerCase()) || title.toLowerCase().includes(tickerNameToCompany(ticker).toLowerCase())){
Â  Â  Â  Â  Â  items.push({title,link});
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }catch(e){}
Â  }
Â  if(items.length===0){ out.innerHTML = '<div style="color:var(--text-muted)">Aucune news rÃ©centes (proxy limitÃ©)</div>'; return; }
Â  const sentiments = items.map(it => {
Â  Â  const text = it.title.toLowerCase();
Â  Â  const score = (text.match(/gain|rise|surge|beat|upgrade|bull/gi)?1:0) - (text.match(/fall|drop|miss|downgrade|bear|loss/gi)?1:0);
Â  Â  return {...it, score};
Â  });
Â  const avg = sentiments.reduce((s,i)=>s+i.score,0)/sentiments.length;
Â  const prob = Math.max(10, Math.min(95, Math.round((0.5 + avg*0.1)*100)));
Â  const mood = avg>0.2? 'Positif' : (avg<-0.2? 'NÃ©gatif' : 'Neutre');
Â  out.innerHTML = `<div style="margin-bottom:6px;color:var(--text-muted)"><strong>Sentiment:</strong> ${mood} â€¢ ProbabilitÃ© estimÃ©e (24h): ${prob}%</div>` + sentiments.slice(0,8).map(it=>`<div style="padding:8px 0;border-bottom:1px solid rgba(0,0,0,0.03)"><a href="${it.link}" target="_blank" style="color:var(--primary)">${it.title}</a></div>`).join('');
}

function tickerNameToCompany(t){
Â  const map = {AAPL:'Apple',TSLA:'Tesla',NVDA:'Nvidia',MSFT:'Microsoft',AMZN:'Amazon',GOOGL:'Google',META:'Meta'};
Â  return map[t]||t;
}

async function loadFundamentals(ticker){
Â  const el = document.getElementById('fundamentals'); el.innerHTML = 'Chargement donnÃ©es...';
Â  try{
Â  Â  const res = await fetch(PROXY + encodeURIComponent(API_QUOTE(ticker)));
Â  Â  const j = await res.json();
Â  Â  const q = j.quoteResponse?.result?.[0];
Â  Â  if(!q){ el.innerHTML='DonnÃ©es indisponibles'; return; }
Â  Â  el.innerHTML = `<div style="display:flex;gap:12px;flex-wrap:wrap">
Â  Â  Â  <div style="min-width:160px"><strong>Prix</strong><div>${formatCurrency(q.regularMarketPrice)}</div></div>
Â  Â  Â  <div style="min-width:160px"><strong>Change %</strong><div>${q.regularMarketChangePercent!=null?q.regularMarketChangePercent.toFixed(2)+'%':'--'}</div></div>
Â  Â  Â  <div style="min-width:160px"><strong>Market Cap</strong><div>${fmtShort(q.marketCap)}</div></div>
Â  Â  Â  <div style="min-width:160px"><strong>Volume</strong><div>${fmtShort(q.regularMarketVolume)}</div></div>
Â  Â  Â  <div style="min-width:160px"><strong>52w H/L</strong><div>${fmt(q.fiftyTwoWeekHigh)} / ${fmt(q.fiftyTwoWeekLow)}</div></div>
Â  Â  Â  <div style="min-width:160px"><strong>PE Ratio</strong><div>${q.trailingPE!=null?q.trailingPE.toFixed(2):'--'}</div></div>
Â  Â  </div>`;
Â  }catch(e){ el.innerHTML='Erreur donnÃ©es'; }
}

/* SCANNER & HEATMAP */
async function updateScannerAndHeatmap(){
Â  const scannerEl = document.getElementById('scannerList'); scannerEl.innerHTML='Chargement...';
Â  const heatEl = document.getElementById('heatmap'); heatEl.innerHTML='';
Â  const rows = [];
Â  for(const s of state.watchlist){
Â  Â  try{
Â  Â  Â  const res = await fetch(PROXY + encodeURIComponent(API_QUOTE(s)));
Â  Â  Â  const j = await res.json(); const q = j.quoteResponse?.result?.[0];
Â  Â  Â  if(!q) continue;
Â  Â  Â  rows.push({symbol:s, changePct: q.regularMarketChangePercent || 0, price: q.regularMarketPrice || 0, vol: q.regularMarketVolume || 0});
Â  Â  }catch(e){}
Â  }
Â  const gainers = [...rows].sort((a,b)=> (b.changePct||0) - (a.changePct||0)).slice(0,5);
Â  const losers = [...rows].sort((a,b)=> (a.changePct||0) - (b.changePct||0)).slice(0,5);
Â  scannerEl.innerHTML = `<div style="font-size:13px;color:var(--text-muted);margin-bottom:6px">Top Gainers</div>` + gainers.map(g=>`<div style="padding:6px 0">${g.symbol} â€¢ ${g.changePct!=null?g.changePct.toFixed(2)+'%':'--'} â€¢ ${formatCurrency(g.price)}</div>`).join('');
Â  scannerEl.innerHTML += `<div style="font-size:13px;color:var(--text-muted);margin-top:8px;margin-bottom:6px">Top Losers</div>` + losers.map(g=>`<div style="padding:6px 0">${g.symbol} â€¢ ${g.changePct!=null?g.changePct.toFixed(2)+'%':'--'} â€¢ ${formatCurrency(g.price)}</div>`).join('');

Â  rows.forEach(r=>{
Â  Â  const tile = el('div',{cls:'heat-tile', onclick:`loadChartFor('${r.symbol}')`});
Â  Â  const pct = r.changePct || 0;
Â  Â  const bg = pct >= 0 ? `linear-gradient(180deg,#e6fff4,#bff1de)` : `linear-gradient(180deg,#ffecec,#ffbdbd)`;
Â  Â  tile.style.background = bg; 
Â  Â  tile.style.opacity = Math.max(0.4, Math.min(1, Math.abs(pct)/5)); 
Â  Â  tile.style.cursor = 'pointer';
Â  Â  tile.style.margin = '4px';
Â  Â  tile.style.padding = '8px';
Â  Â  tile.style.borderRadius = '6px';
Â  Â  tile.style.display = 'inline-block';
Â  Â  tile.innerHTML = `<div style="font-weight:800">${r.symbol}</div><div style="font-size:12px">${pct!=null?pct.toFixed(2)+'%':'--'}</div>`;
Â  Â  heatEl.appendChild(tile);
Â  });
}

/* ALERTS / POSITION / PAPER / CSV */
function createAlert(){
Â  const t = document.getElementById('alertTicker').value.trim().toUpperCase();
Â  const p = parseFloat(document.getElementById('alertPrice').value);
Â  const d = document.getElementById('alertDir').value;
Â  if(!t || !p) { alert('Remplir ticker et prix'); return; }
Â  state.alerts.push({ticker:t, price:p, direction:d, triggered:false});
Â  storeState(); renderAlertsUI(); document.getElementById('alertTicker').value=''; document.getElementById('alertPrice').value=''; showPopup('Alerte crÃ©Ã©e: '+t);
}

function calculatePosition(){
Â  const account = parseFloat(document.getElementById('accountSize').value);
Â  const riskPct = parseFloat(document.getElementById('riskPct').value);
Â  const stop = parseFloat(document.getElementById('stopDist').value);
Â  if(!account || !riskPct || !stop){ document.getElementById('positionResult').textContent='Remplir tous les champs'; return; }
Â  const riskAmount = account * (riskPct/100);
Â  const qty = Math.max(0, Math.floor(riskAmount / stop));
Â  document.getElementById('positionResult').textContent = `Taille: ${qty} actions (risque ${riskAmount.toFixed(2)} ${state.currency})`;
}

function addPaperTrade(){
Â  const t = document.getElementById('ptTicker').value.trim().toUpperCase();
Â  const qty = parseFloat(document.getElementById('ptQty').value);
Â  const price = parseFloat(document.getElementById('ptPrice').value);
Â  if(!t || !qty || !price){ alert('Remplir trade'); return; }
Â  state.paperTrades.push({ticker:t, qty, price, when: Date.now()});
Â  storeState(); renderPaperTrades();
Â  document.getElementById('ptTicker').value=''; document.getElementById('ptQty').value=''; document.getElementById('ptPrice').value='';
Â  showPopup('Trade ajoutÃ© (paper)');
}

function downloadCSV(){
Â  const rows = [['Ticker','Price','Change%']];
Â  Promise.all(state.watchlist.map(async t=>{
Â  Â  try{ const r = await fetch(PROXY + encodeURIComponent(API_QUOTE(t))); const j = await r.json(); const q = j.quoteResponse.result[0]; rows.push([t, q.regularMarketPrice || '', q.regularMarketChangePercent || '']); }catch(e){ rows.push([t,'','']); }
Â  })).then(()=>{
Â  Â  const csv = rows.map(r=> r.map(c=> `"${c}"`).join(',')).join('\n');
Â  Â  const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
Â  Â  const a = document.createElement('a'); a.href = url; a.download = 'watchlist.csv'; a.click(); URL.revokeObjectURL(url);
Â  });
}

/* REFRESH / LIVE / STORAGE / UTILS */
function storeState(){ localStorage.setItem('watchlist', JSON.stringify(state.watchlist)); localStorage.setItem('alerts', JSON.stringify(state.alerts)); localStorage.setItem('paperTrades', JSON.stringify(state.paperTrades)); }
function addTickerFromInput(){ const v=document.getElementById('addTickerInput').value.trim().toUpperCase(); if(!v) return; if(!state.watchlist.includes(v)) state.watchlist.push(v); document.getElementById('addTickerInput').value=''; storeState(); renderWatchlist(); renderTableList(); updateScannerAndHeatmap(); }
function showPopup(text){ const p = el('div',{cls:'popup'}, text); document.getElementById('popupContainer').appendChild(p); setTimeout(()=>p.remove(),4200); }
function showOnboarding(){ document.getElementById('onboarding').style.display='flex'; }
function closeOnboarding(){ document.getElementById('onboarding').style.display='none'; }

async function refreshAll(){
Â  for(const t of state.watchlist){
Â  Â  try{
Â  Â  Â  const res = await fetch(PROXY + encodeURIComponent(API_QUOTE(t)));
Â  Â  Â  const j = await res.json(); const q = j.quoteResponse?.result?.[0];
Â  Â  Â  if(!q) continue;
Â  Â  Â  const price = q.regularMarketPrice; const ch = q.regularMarketChangePercent;
Â  Â  Â  
Â  Â  Â  // Update table
Â  Â  Â  const rowPrice = document.getElementById('row-price-'+t); if(rowPrice) rowPrice.textContent = formatCurrency(price);
Â  Â  Â  const rowCh = document.getElementById('row-change-'+t); if(rowCh){ rowCh.textContent = (ch!=null? ch.toFixed(2)+'%':'--'); rowCh.style.color = ch>0? '#05603a' : (ch<0? '#7f1d1d' : '#082033'); }
Â  Â  Â  
Â  Â  Â  // alerts
Â  Â  Â  state.alerts.forEach(a=>{
Â  Â  Â  Â  if(!a.triggered && a.ticker===t){
Â  Â  Â  Â  Â  if((a.direction==='above' && price >= a.price) || (a.direction==='below' && price <= a.price)){
Â  Â  Â  Â  Â  Â  showPopup(`ALERTE: ${t} ${formatCurrency(price)} (${a.direction==='above'?'>':'<'} ${formatCurrency(a.price)})`);
Â  Â  Â  Â  Â  Â  a.triggered = true; storeState();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }catch(e){}
Â  }
Â  renderWatchlist(); renderTableList(); renderAlertsUI(); renderPaperTrades(); updateScannerAndHeatmap();
Â  
Â  if (state.currentTicker) {
Â  Â  loadChartFor(state.currentTicker); 
Â  }
}

/* live poll */
function toggleRealtime(){
Â  if(state.liveInterval){ clearInterval(state.liveInterval); state.liveInterval = null; showPopup('Live stoppÃ©'); return; }
Â  state.liveInterval = setInterval(refreshAll, 5000);
Â  showPopup('Live dÃ©marrÃ© (5s)');
}

/* format currency */
function formatCurrency(n){
Â  if(n==null || isNaN(n)) return '--';
Â  const symbol = state.currency==='CAD' || state.currency==='USD' ? '$' : 'â‚¬';
Â  const val = Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
Â  return `${val} ${symbol}`;
}

/* chart type switch */
function switchChartType(v){ 
Â  state.chartType = v; 
Â  if (state.currentTicker) {
Â  Â  loadChartFor(state.currentTicker); 
Â  }
}

/* INIT */
document.addEventListener('DOMContentLoaded', () => {
Â  document.getElementById('currencySelect').value = state.currency;
Â  document.getElementById('rangeSelect').value = state.currentRange;
Â  refreshAll();
Â  setInterval(storeState, 5000);
});
</script>
</body>
</html>
