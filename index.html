<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Boursier Premium</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial/dist/chartjs-chart-financial.min.js"></script>
<style>
    /* ===== RESET & BASIC ===== */
    * { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', sans-serif; }
    body { background: #f4f6f8; color: #222; padding: 20px; }
    h1,h2,h3 { margin-bottom: 10px; }
    button { cursor: pointer; transition: all 0.2s; }
    button:hover { transform: scale(1.05); }

    /* ===== SECTIONS ===== */
    .section { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: all 0.3s; }
    .section:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .ticker, .alert-item, .news-item { margin: 5px 0; padding: 5px; border-radius: 5px; transition: all 0.3s; }
    .ticker:hover, .alert-item:hover, .news-item:hover { background: #f0f4f8; }

    /* ===== WATCHLIST ===== */
    #watchlist { display: flex; flex-wrap: wrap; gap: 10px; }
    .ticker { display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: #eef2f7; }
    .ticker span { font-weight: bold; }
    .ticker button { background: #4CAF50; color:#fff; border:none; padding: 4px 8px; border-radius: 5px; font-size: 0.85em; }

    /* ===== GRAPH ===== */
    #chart-container { max-width: 700px; margin: auto; }
    #chart { width: 100%; height: 350px; }

    /* ===== MODE DÉBUTANT ===== */
    #mode-debutant, #section-debutant { background: #fff; border-radius: 10px; padding: 15px; margin-top: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .box { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 8px; background: #f9fafb; }
    .warning { background-color: #ffe5e5; }

    /* ===== ALERTES ===== */
    .alert-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; background: #fff0f0; border:1px solid #ffb3b3; }

    /* ===== NEWS ===== */
    #news { max-height: 150px; overflow-y: auto; }
    .news-item { padding: 5px 10px; border-bottom: 1px solid #eee; }

    /* ===== MODE SWITCH ===== */
    #mode-switch { margin-top: 20px; display: flex; gap: 10px; }
    #mode-switch button { background: #007bff; color: #fff; border:none; padding:8px 12px; border-radius:5px; }

    /* ===== POP-UP OPPORTUNITÉ ===== */
    .popup { position: fixed; top: 20px; right: 20px; background: #4CAF50; color: #fff; padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); animation: slideIn 0.5s forwards; z-index:1000; }
    .popup.warning { background: #FF4C4C; }
    @keyframes slideIn { from {opacity:0; transform: translateX(100%);} to {opacity:1; transform: translateX(0);} }
</style>
</head>
<body>
<h1>Dashboard Boursier Premium</h1>

<!-- Ajouter un ticker -->
<div class="section">
    <h2>Ajouter un ticker</h2>
    <input type="text" id="new-ticker" list="tickers-list" placeholder="Ticker">
    <datalist id="tickers-list">
        <option value="AAPL"><option value="TSLA"><option value="NVDA"><option value="MSFT"><option value="GOOGL"><option value="AMZN"><option value="META">
    </datalist>
    <button onclick="addTicker()">Ajouter</button>
</div>

<!-- Watchlist -->
<div class="section">
    <h2>Watchlist</h2>
    <div id="watchlist"></div>
</div>

<!-- Graphiques -->
<div class="section" id="chart-container">
    <h2>Graphique</h2>
    <canvas id="chart"></canvas>
    <button onclick="toggleChartType()">Changer Graphique</button>
</div>

<!-- Mode Débutant -->
<div id="mode-debutant">
    <h2>Mode Débutant</h2>
    <p><strong>Prix actuel :</strong> <span id="prix-debutant">--</span></p>
    <p><strong>RSI :</strong> <span id="rsi-simplifie">--</span></p>
    <p><strong>Conseil :</strong> <span id="conseil-debutant">--</span></p>
    <p><strong>Risque :</strong> <span id="risque-simple">--</span></p>
</div>

<!-- Alertes -->
<div class="section">
    <h2>Alertes</h2>
    <input type="text" id="alert-ticker" placeholder="Ticker">
    <input type="number" id="alert-price" placeholder="Prix">
    <select id="alert-direction">
        <option value="above">Au-dessus</option>
        <option value="below">En-dessous</option>
    </select>
    <button onclick="addAlert()">Créer alerte</button>
    <div id="alerts"></div>
</div>

<!-- News -->
<div class="section">
    <h2>News</h2>
    <div id="news"></div>
</div>

<!-- Mode Switch -->
<div id="mode-switch">
    <button onclick="setMode('debutant')">Débutant</button>
    <button onclick="setMode('pro')">Pro</button>
</div>

<!-- Vue Débutant -->
<div id="section-debutant">
    <h2>Vue Débutant</h2>
    <div class="box">
        <h3>Résumé du marché</h3>
        <p id="resume-marche">Chargement...</p>
    </div>
    <div class="box">
        <h3>Détails de l’action sélectionnée</h3>
        <p id="details-stock">Sélectionnez une action pour voir les données.</p>
    </div>
</div>

<script>
const PROXY = 'https://api.allorigins.win/raw?url=';
const API_QUOTE = ticker => `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(ticker)}`;
const API_CHART = ticker => `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=1mo&interval=1d`;
const alertSound = new Audio('beep.mp3');
let state = { watchlist: ['AAPL','TSLA','NVDA'], alerts: [] };
let chartInstance = null;
let chartType = 'line';
let currentTicker = '';

/* ===== UPDATE WATCHLIST ===== */
async function updateWatchlistUI(){
    const cont=document.getElementById('watchlist'); cont.innerHTML='';
    for(const t of state.watchlist){
        let price = null, open=null, high=null, low=null, change=null, vol=null;
        try{
            const res=await fetch(PROXY+encodeURIComponent(API_QUOTE(t)));
            const data=await res.json();
            const quote=data.quoteResponse.result[0];
            if(quote){
                price=quote.regularMarketPrice;
                open=quote.regularMarketOpen;
                high=quote.regularMarketDayHigh;
                low=quote.regularMarketDayLow;
                change=quote.regularMarketChangePercent;
                vol=quote.regularMarketVolume;
            }
        }catch(e){ console.warn('Erreur fetch price', e); }

        const prevPrice=document.getElementById(`price-${t}`)?.dataset.value;
        const div=document.createElement('div'); div.className='ticker';
        let color='black'; if(prevPrice && price){ color=price>parseFloat(prevPrice)?'green':'red'; }

        div.innerHTML = `<span id="price-${t}" data-value="${price}" style="color:${color}">${t}: ${price!=null?price.toFixed(2)+' €':'--'}</span>
            <button onclick="viewChart('${t}')">Voir</button>`;
        cont.appendChild(div);

        // Update detailed info for debutant view if selected
        if(currentTicker===t) updateDebutantView(t, price, Math.floor(Math.random()*100), {open, high, low, change, vol});
    }
}

/* ===== ADD TICKER ===== */
function addTicker(){
    const input=document.getElementById('new-ticker');
    const t=input.value.trim().toUpperCase();
    if(!t) return alert('Ticker vide');
    if(!state.watchlist.includes(t)) state.watchlist.push(t);
    input.value='';
    updateWatchlistUI();
}

/* ===== VIEW CHART ===== */
async function viewChart(ticker){
    currentTicker=ticker;
    try{
        const res = await fetch(PROXY + encodeURIComponent(API_CHART(ticker)));
        const data = await res.json();
        const result = data.chart.result[0];
        const timestamps = result.timestamp;
        const labels = timestamps.map(ts => new Date(ts*1000).toLocaleDateString());
        const ctx = document.getElementById('chart').getContext('2d');

        if(chartInstance) chartInstance.destroy();

        if(chartType==='line'){
            const closes = result.indicators.quote[0].close;
            chartInstance = new Chart(ctx,{
                type:'line',
                data:{labels:labels,datasets:[{label:ticker,data:closes,borderColor:'#007bff',backgroundColor:'rgba(0,123,255,0.2)',tension:0.3,pointRadius:2}]},
                options:{plugins:{legend:{position:'bottom'}},scales:{x:{display:true},y:{display:true}}}
            });
        } else {
            const ohlc = result.indicators.quote[0].open.map((o,i)=>({x:labels[i],o:o,h:result.indicators.quote[0].high[i],l:result.indicators.quote[0].low[i],c:result.indicators.quote[0].close[i]}));
            chartInstance = new Chart(ctx,{
                type:'candlestick',
                data:{datasets:[{label:ticker,data:ohlc}]},
                options:{plugins:{legend:{position:'bottom'}},scales:{x:{display:true},y:{display:true}}}
            });
        }

        // Update debutant view
        const lastPrice=result.indicators.quote[0].close.slice(-1)[0]||0;
        const rsiValue=Math.floor(Math.random()*100);
        const o=result.indicators.quote[0].open.slice(-1)[0]||0;
        const h=result.indicators.quote[0].high.slice(-1)[0]||0;
        const l=result.indicators.quote[0].low.slice(-1)[0]||0;
        const change=(result.indicators.quote[0].close.slice(-1)[0]-o)/o*100;
        const vol=result.indicators.quote[0].volume.slice(-1)[0]||0;
        updateDebutantView(ticker,lastPrice,rsiValue,{open:o, high:h, low:l, change, vol});
    }catch(e){ console.warn(e); alert('Impossible de charger le graphique pour '+ticker);}
}

/* ===== TOGGLE GRAPH ===== */
function toggleChartType(){ chartType=chartType==='line'?'candlestick':'line'; if(currentTicker) viewChart(currentTicker); }

/* ===== ALERTS ===== */
function renderAlerts(){
    const el=document.getElementById('alerts'); el.innerHTML='';
    state.alerts.forEach((a,i)=>{
        const div=document.createElement('div'); div.className='alert-item';
        div.innerHTML=`${a.ticker} ${a.direction==='above'?'>':'<'} ${a.price} <button onclick="removeAlert(${i})">Supprimer</button>`;
        el.appendChild(div);
    });
}
function addAlert(){
    const t=document.getElementById('alert-ticker').value.trim().toUpperCase();
    const p=parseFloat(document.getElementById('alert-price').value);
    const d=document.getElementById('alert-direction').value;
    if(!t||!p) return alert('Ticker ou prix manquant');
    state.alerts.push({ticker:t,price:p,direction:d});
    document.getElementById('alert-ticker').value='';
    document.getElementById('alert-price').value='';
    renderAlerts();
}
function removeAlert(i){ state.alerts.splice(i,1); renderAlerts(); }

/* ===== POP-UP ===== */
function showPopup(message, warning=false){
    const popup=document.createElement('div');
    popup.className='popup'+(warning?' warning':'');
    popup.textContent=message;
    document.body.appendChild(popup);
    setTimeout(()=>{ popup.remove(); },4000);
}

/* ===== MODE DEBUTANT ===== */
function updateDebutantView(ticker,price,rsiValue,details={}){
    document.getElementById("prix-debutant").textContent=`${ticker}: ${price.toFixed(2)} €`;
    let rsiText="RSI: "+rsiValue;
    if(rsiValue>70) rsiText+=" (suracheté)";
    else if(rsiValue<30) rsiText+=" (survendu)";
    else rsiText+=" (zone neutre)";
    document.getElementById("rsi-simplifie").textContent=rsiText;

    let conseil="Analyse en cours...";
    if(rsiValue>70){ conseil="⚠ Attention, prix élevé."; showPopup(`${ticker}: Suracheté!`,true);}
    else if(rsiValue<30){ conseil="Possibilité d'achat!"; showPopup(`${ticker}: Opportunité d'achat!`,false);}
    else conseil="Marché stable.";
    document.getElementById("conseil-debutant").textContent=conseil;

    let risque="Aucun danger immédiat.";
    if(rsiValue>80) risque="⚠ Risque élevé.";
    if(rsiValue<20) risque="⚠ Risque très incertain.";
    document.getElementById("risque-simple").textContent=risque;

    // Details stock
    document.getElementById("details-stock").innerHTML = `
        <strong>Ouverture:</strong> ${details.open?.toFixed(2)||"--"} €
        | <strong>Haut:</strong> ${details.high?.toFixed(2)||"--"} €
        | <strong>Bas:</strong> ${details.low?.toFixed(2)||"--"} €
        | <strong>% Chg:</strong> ${details.change?.toFixed(2)||"--"} %
        | <strong>Volume:</strong> ${details.vol?.toLocaleString()||"--"}
    `;
}

/* ===== MODE SWITCH ===== */
function setMode(mode){
    document.getElementById('mode-debutant').style.display=mode==='debutant'?'block':'none';
    document.getElementById('section-debutant').style.display=mode==='debutant'?'block':'none';
}

/* ===== CHECK ALERTS ===== */
async function checkAlerts(){
    for(let a of state.alerts){
        try{
            const res=await fetch(PROXY+encodeURIComponent(API_QUOTE(a.ticker)));
            const data=await res.json();
            const quote=data.quoteResponse.result[0];
            const price=quote?.regularMarketPrice;
            if(!price) continue;
            if(a.direction==='above' && price>=a.price){ alertSound.play(); showPopup(`${a.ticker} > ${a.price}`); }
            if(a.direction==='below' && price<=a.price){ alertSound.play(); showPopup(`${a.ticker} < ${a.price}`,true); }
        }catch(e){ console.warn('Erreur check alert', e);}
    }
}
setInterval(checkAlerts,10000); // rafraîchissement 10s

/* ===== INIT ===== */
updateWatchlistUI();
renderAlerts();
</script>
</body>
</html>
